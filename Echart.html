<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio V108 (Nuclear Animation Fix)</title>

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ Apple Human Interface Guidelines â€” Premium Redesign
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        /* â”€â”€ Design Tokens â”€â”€ */
        :root {
            /* Surfaces */
            --app-bg: #f2f2f7;
            --surface: #ffffff;
            --surface-elevated: rgba(255, 255, 255, 0.82);
            --surface-card: rgba(255, 255, 255, 0.65);
            --glass-bg: rgba(255, 255, 255, 0.72);

            /* Typography */
            --text-primary: #1d1d1f;
            --text-secondary: #636366;
            --text-tertiary: #aeaeb2;
            --text-quaternary: #c7c7cc;

            /* System Colors */
            --blue: #007aff;
            --blue-hover: #0a84ff;
            --blue-light: rgba(0, 122, 255, 0.10);
            --blue-glow: rgba(0, 122, 255, 0.30);
            --green: #34c759;
            --green-hover: #30d158;
            --green-light: rgba(52, 199, 89, 0.10);
            --orange: #ff9500;
            --red: #ff3b30;
            --red-light: rgba(255, 59, 48, 0.10);
            --purple: #af52de;
            --indigo: #5856d6;
            --teal: #5ac8fa;

            /* Fills */
            --fill-primary: rgba(120, 120, 128, 0.20);
            --fill-secondary: rgba(120, 120, 128, 0.12);
            --fill-tertiary: rgba(120, 120, 128, 0.08);
            --fill-quaternary: rgba(120, 120, 128, 0.04);

            /* Borders & Separators */
            --separator: rgba(60, 60, 67, 0.10);
            --separator-opaque: #c6c6c8;

            /* Radii */
            --radius-xs: 6px;
            --radius-sm: 8px;
            --radius: 10px;
            --radius-lg: 14px;
            --radius-xl: 18px;
            --radius-2xl: 22px;
            --radius-pill: 980px;

            /* Shadows */
            --shadow-xs: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.16);

            /* Animations */
            --spring: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --spring-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);

            /* Font */
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", "Segoe UI", Roboto, sans-serif;
            --font-mono: "SF Mono", "Menlo", "Monaco", "Cascadia Code", "Fira Code", Consolas, monospace;
        }

        /* â”€â”€ Reset â”€â”€ */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            outline: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            background: var(--app-bg);
            color: var(--text-primary);
            font-family: var(--font);
            font-size: 14px;
            line-height: 1.5;
            overflow: hidden;
        }

        /* â”€â”€ Ripple Animation â”€â”€ */
        @keyframes ripple-expand {
            0% {
                transform: scale(0);
                opacity: 0.4;
            }

            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.08);
            width: 40px;
            height: 40px;
            margin-top: -20px;
            margin-left: -20px;
            pointer-events: none;
            animation: ripple-expand 0.55s var(--ease-out-expo) forwards;
        }

        .btn-main .ripple {
            background: rgba(255, 255, 255, 0.25);
        }

        /* â”€â”€ Modal Animations â”€â”€ */
        @keyframes modalFadeIn {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes modalSlideUp {
            0% {
                transform: scale(0.92) translateY(12px);
                opacity: 0;
            }

            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 4px 16px rgba(255, 59, 48, 0.35);
            }

            50% {
                box-shadow: 0 4px 24px rgba(255, 59, 48, 0.55), 0 0 0 6px rgba(255, 59, 48, 0.12);
            }
        }

        @keyframes progress-shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        /* â•â•â• SIDEBAR â•â•â• */
        #sidebar {
            width: 380px;
            min-width: 320px;
            background: var(--surface-elevated);
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border-right: 1px solid var(--separator);
            display: flex;
            flex-direction: column;
            z-index: 100;
            padding: 0;
            box-shadow: 1px 0 0 var(--separator), 4px 0 24px rgba(0, 0, 0, 0.03);
        }

        #sidebar .sidebar-header {
            flex-shrink: 0;
            padding: 24px 24px 18px 24px;
            border-bottom: 1px solid var(--separator);
            background: var(--surface);
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.025em;
            line-height: 1.2;
            color: var(--text-primary);
        }

        h2 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin: 0 0 10px 0;
        }

        .label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: block;
            letter-spacing: -0.01em;
        }

        /* â”€â”€ Control Sections (Card Style) â”€â”€ */
        .control-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 16px 20px;
            margin: 6px 12px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--separator);
            box-shadow: var(--shadow-xs);
            transition: box-shadow 0.2s var(--spring);
        }

        .control-section:hover {
            box-shadow: var(--shadow-sm);
        }

        .control-section:last-of-type {
            border-bottom: none;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .col {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* â•â• INPUT FIELDS â•â• */
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px 13px;
            background: var(--fill-tertiary);
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.22s var(--spring);
        }

        input[type="text"]:hover,
        input[type="number"]:hover,
        select:hover,
        textarea:hover {
            background: var(--fill-secondary);
            border-color: var(--separator);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            background: var(--surface);
            border-color: var(--blue);
            box-shadow: 0 0 0 3px var(--blue-light), var(--shadow-sm);
            transform: translateY(-0.5px);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='none' viewBox='0 0 10 10'%3E%3Cpath d='M2 3.5L5 6.5L8 3.5' stroke='%23aeaeb2' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }

        /* â•â• RANGE SLIDER â•â• */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: linear-gradient(90deg, var(--blue-light), var(--fill-primary));
            border-radius: var(--radius-pill);
            transition: background 0.2s;
            border: none;
            padding: 0;
        }

        input[type="range"]:hover {
            background: linear-gradient(90deg, rgba(0, 122, 255, 0.20), var(--fill-primary));
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--surface);
            border: none;
            cursor: pointer;
            box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1), 0 1px 4px rgba(0, 0, 0, 0.12), 0 0 0 0.5px rgba(0, 0, 0, 0.04);
            transition: transform 0.18s var(--spring-bounce), box-shadow 0.18s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.12);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.14), 0 0 0 0.5px rgba(0, 0, 0, 0.06);
        }

        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(0.95);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: none;
            background: var(--surface);
            cursor: pointer;
            box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1), 0 1px 4px rgba(0, 0, 0, 0.12);
        }

        /* â•â• iOS TOGGLE SWITCH â•â• */
        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 42px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--fill-primary);
            border-radius: 26px;
            transition: background 0.25s var(--spring), box-shadow 0.25s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--surface);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15), 0 1px 1px rgba(0, 0, 0, 0.06);
            transition: transform 0.25s var(--spring-bounce);
        }

        .toggle input:checked+.toggle-slider {
            background: var(--blue);
        }

        .toggle input:checked+.toggle-slider::before {
            transform: translateX(16px);
        }

        .toggle input:focus-visible+.toggle-slider {
            box-shadow: 0 0 0 3px var(--blue-light);
        }

        input[type="checkbox"]:not(.toggle input) {
            width: 18px;
            height: 18px;
            accent-color: var(--blue);
            cursor: pointer;
        }

        /* â•â• BUTTONS â€” with spring feedback â•â• */
        .btn-main,
        .btn-sec,
        .zoom-btn {
            position: relative;
            overflow: hidden;
        }

        .btn-main {
            background: linear-gradient(180deg, #0a84ff 0%, #007aff 100%);
            color: #fff;
            border: none;
            padding: 11px 20px;
            border-radius: var(--radius-pill);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            letter-spacing: -0.01em;
            transition: all 0.22s var(--spring);
            width: 100%;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 1px 2px rgba(0, 122, 255, 0.20), 0 4px 12px rgba(0, 122, 255, 0.15);
        }

        .btn-main:hover {
            background: linear-gradient(180deg, #3399ff 0%, #0a84ff 100%);
            box-shadow: 0 2px 4px rgba(0, 122, 255, 0.25), 0 6px 20px rgba(0, 122, 255, 0.20);
            transform: translateY(-0.5px);
        }

        .btn-main:active {
            transform: scale(0.97) translateY(0.5px);
            box-shadow: 0 1px 2px rgba(0, 122, 255, 0.15);
            transition-duration: 0.08s;
        }

        .btn-main.btn-success {
            background: linear-gradient(180deg, #30d158 0%, #34c759 100%);
            box-shadow: 0 1px 2px rgba(52, 199, 89, 0.20), 0 4px 12px rgba(52, 199, 89, 0.15);
        }

        .btn-main.btn-success:hover {
            background: linear-gradient(180deg, #4dd97a 0%, #30d158 100%);
            box-shadow: 0 2px 4px rgba(52, 199, 89, 0.25), 0 6px 20px rgba(52, 199, 89, 0.20);
        }

        .btn-main.btn-success:active {
            transform: scale(0.97) translateY(0.5px);
            box-shadow: 0 1px 2px rgba(52, 199, 89, 0.15);
        }

        .btn-sec {
            background: var(--fill-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--separator);
            padding: 10px 18px;
            border-radius: var(--radius-pill);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            letter-spacing: -0.01em;
            transition: all 0.22s var(--spring);
            width: 100%;
        }

        .btn-sec:hover {
            background: var(--fill-secondary);
            border-color: var(--separator-opaque);
            box-shadow: var(--shadow-xs);
            transform: translateY(-0.5px);
        }

        .btn-sec:active {
            transform: scale(0.97) translateY(0.5px);
            background: var(--fill-primary);
            transition-duration: 0.08s;
        }

        /* â•â• CODE EDITOR â•â• */
        #code-area {
            font-family: var(--font-mono);
            font-size: 12.5px;
            line-height: 1.55;
            background: #1a1a1e;
            color: #e5e5ea;
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--radius-lg);
            padding: 14px 16px;
            resize: none;
            flex: 1;
            min-height: 120px;
            transition: all 0.22s var(--spring);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        #code-area:hover {
            border-color: rgba(255, 255, 255, 0.10);
        }

        #code-area:focus {
            border-color: var(--blue);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 0 0 3px var(--blue-light);
            transform: translateY(-0.5px);
        }

        #code-area::placeholder {
            color: #48484a;
        }

        #code-area::selection {
            background: rgba(0, 122, 255, 0.35);
        }

        /* â•â• PREVIEW STAGE â•â• */
        #preview-stage {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background:
                radial-gradient(ellipse at 30% 20%, rgba(0, 122, 255, 0.03) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 80%, rgba(175, 82, 222, 0.03) 0%, transparent 60%),
                #ececf0;
            cursor: default;
        }

        /* Subtle dot grid */
        #preview-stage::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: radial-gradient(circle at 1px 1px, rgba(0, 0, 0, 0.07) 1px, transparent 0);
            background-size: 24px 24px;
            pointer-events: none;
        }

        #preview-stage:hover {
            cursor: grab;
        }

        #chart-container:hover {
            cursor: default;
        }

        #chart-container {
            min-width: 100px;
            min-height: 100px;
            background: var(--surface);
            box-shadow: var(--shadow-lg), 0 0 0 1px rgba(0, 0, 0, 0.04);
            border-radius: var(--radius-xl);
            transform-origin: center center;
        }

        /* â•â• ZOOM TOOLBAR â•â• */
        #zoom-toolbar {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(24px) saturate(200%);
            -webkit-backdrop-filter: blur(24px) saturate(200%);
            padding: 5px 6px 5px 14px;
            border-radius: var(--radius-pill);
            display: flex;
            align-items: center;
            gap: 2px;
            box-shadow: var(--shadow), 0 0 0 0.5px rgba(0, 0, 0, 0.06);
            z-index: 100;
            border: 0.5px solid rgba(255, 255, 255, 0.5);
        }

        .zoom-btn {
            background: transparent;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-primary);
            width: 34px;
            height: 34px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: var(--radius-sm);
            transition: all 0.18s var(--spring);
        }

        .zoom-btn:hover {
            background: var(--fill-secondary);
        }

        .zoom-btn:active {
            transform: scale(0.92);
            background: var(--fill-primary);
            transition-duration: 0.06s;
        }

        #zoom-toolbar .zoom-divider {
            width: 1px;
            height: 18px;
            background: var(--separator);
            margin: 0 4px;
        }

        #zoom-level {
            font-size: 12px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            min-width: 42px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* â•â• FREEZE BADGE â•â• */
        #freeze-badge {
            position: absolute;
            top: 24px;
            right: 24px;
            background: linear-gradient(135deg, #ff3b30 0%, #ff6259 100%);
            color: #fff;
            padding: 8px 16px;
            border-radius: var(--radius-pill);
            font-size: 12px;
            font-weight: 600;
            letter-spacing: -0.01em;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 16px rgba(255, 59, 48, 0.35);
            display: none;
            pointer-events: none;
            z-index: 50;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* â•â• MODAL â•â• */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(12px) saturate(150%);
            -webkit-backdrop-filter: blur(12px) saturate(150%);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: modalFadeIn 0.2s ease-out;
        }

        .modal-card {
            background: var(--surface);
            width: 420px;
            max-width: 90vw;
            padding: 28px 24px;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl), 0 0 0 0.5px rgba(0, 0, 0, 0.06);
            text-align: center;
            animation: modalSlideUp 0.32s var(--spring-bounce);
        }

        .progress-bar {
            height: 4px;
            background: var(--fill-secondary);
            border-radius: var(--radius-pill);
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            border-radius: var(--radius-pill);
            background: linear-gradient(90deg, var(--blue), var(--teal));
            background-size: 200% 100%;
            animation: progress-shimmer 2s ease-in-out infinite;
            transition: width 0.15s linear;
        }

        /* â•â• SIDEBAR SCROLLBAR â•â• */
        .sidebar-scroll {
            scrollbar-width: thin;
            scrollbar-color: var(--fill-primary) transparent;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: var(--fill-primary);
            border-radius: var(--radius-pill);
        }

        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        #sidebar a {
            color: var(--blue);
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.15s;
        }

        #sidebar a:hover {
            opacity: 0.7;
            text-decoration: none;
        }

        #sidebar a:active {
            opacity: 0.5;
        }

        /* â•â• DEEPSEEK MODAL â•â• */
        #deepseek-modal .modal-card {
            width: 520px;
            max-width: 92vw;
            max-height: 88vh;
            overflow-y: auto;
            text-align: left;
            padding: 24px;
        }

        #deepseek-modal .modal-card h1 {
            font-size: 18px;
            margin: 0 0 16px 0;
            text-align: center;
        }

        #deepseek-modal .label {
            margin-bottom: 6px;
        }

        #deepseek-modal textarea {
            min-height: 80px;
            font-family: var(--font-mono);
            font-size: 12px;
        }

        #deepseek-modal #deepseek-result {
            min-height: 120px;
            background: #1a1a1e;
            color: #e5e5ea;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        #deepseek-modal .deepseek-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            justify-content: flex-end;
        }

        #deepseek-modal .deepseek-status {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 8px;
            min-height: 16px;
        }

        /* â•â• Chat Messages â•â• */
        .deepseek-chat-msg {
            display: flex;
            flex-direction: column;
            padding: 10px 14px;
            border-radius: var(--radius-lg);
            max-width: 78%;
            word-break: break-word;
        }

        .deepseek-chat-msg.user {
            align-self: flex-end;
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.10) 0%, rgba(0, 122, 255, 0.06) 100%);
            color: #1c3a5f;
            border: 1px solid rgba(0, 122, 255, 0.10);
        }

        .deepseek-chat-msg.assistant {
            align-self: flex-start;
            background: var(--fill-quaternary);
            color: var(--text-primary);
            border: 1px solid var(--separator);
        }

        .deepseek-chat-msg .meta {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-bottom: 6px;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
        }

        .deepseek-chat-msg .meta .role {
            font-weight: 600;
            font-size: 11px;
            color: inherit;
        }

        .deepseek-chat-msg .content {
            white-space: pre-wrap;
            font-family: var(--font-mono);
            font-size: 12.5px;
            color: inherit;
            line-height: 1.5;
        }

        .deepseek-chat-msg .actions {
            margin-top: 8px;
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }

        .deepseek-chat-msg .actions button {
            padding: 5px 10px;
            border-radius: var(--radius-xs);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            background: var(--fill-tertiary);
            border: 1px solid var(--separator);
            color: var(--text-primary);
            transition: all 0.18s var(--spring);
        }

        .deepseek-chat-msg .actions button:hover {
            background: var(--fill-secondary);
        }

        .deepseek-chat-msg .actions button:active {
            transform: scale(0.95);
        }

        #deepseek-modal .deepseek-tab.active {
            background: var(--surface);
            color: var(--blue);
            font-weight: 600;
            box-shadow: var(--shadow-xs);
        }

        /* â•â• Status Badge â•â• */
        .version-badge {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-tertiary);
            background: var(--fill-tertiary);
            padding: 5px 10px;
            border-radius: var(--radius-pill);
            letter-spacing: 0.04em;
        }

        /* â•â• Code Status â•â• */
        #code-status {
            font-size: 11px;
            color: var(--text-tertiary);
            min-height: 16px;
            margin-top: 6px;
            padding: 0 2px;
        }

        /* â”€â”€ Page Navigation Segmented Control â”€â”€ */
        .page-nav-bar {
            display: flex;
            gap: 2px;
            background: rgba(0, 0, 0, 0.06);
            border-radius: 10px;
            padding: 3px;
            margin-bottom: 12px;
        }

        .page-nav-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 4px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-decoration: none;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            white-space: nowrap;
        }

        .page-nav-item:hover {
            color: #1d1d1f;
            background: rgba(255, 255, 255, 0.5);
        }

        .page-nav-item.active {
            background: #fff;
            color: #007aff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);
            pointer-events: none;
        }
    </style>
</head>

<body>

    <div id="freeze-badge">â„ï¸ æ ‡ç­¾å·²å›ºå®š (åŒå‡»æˆ–å³é”®è§£å†»ï¼Œæˆªå›¾ä¼šä¿ç•™)</div>

    <div id="zoom-toolbar">
        <button class="zoom-btn" onclick="App.zoom(-0.1)" title="ç¼©å°">âˆ’</button>
        <span id="zoom-level">45%</span>
        <button class="zoom-btn" onclick="App.zoom(0.1)" title="æ”¾å¤§">+</button>
        <div class="zoom-divider"></div>
        <button class="zoom-btn" onclick="App.autoFit()"
            style="width:auto; padding:0 10px; font-size:12px; font-weight:600;">Fit</button>
        <button class="zoom-btn" onclick="App.resetZoom()"
            style="width:auto; padding:0 10px; font-size:12px; font-weight:600;">1:1</button>
    </div>

    <div id="render-modal" class="modal-overlay">
        <div class="modal-card">
            <h1 style="font-size:18px; font-weight:700; margin:0 0 6px 0; letter-spacing:-0.02em;">æ­£åœ¨å¯¼å‡º (V108)</h1>
            <p id="render-status" style="color:var(--text-secondary); font-size:13px; margin:0 0 16px 0;">æ­£åœ¨å¼ºåˆ¶æ³¨å…¥åŠ¨ç”»...
            </p>
            <div class="progress-bar">
                <div id="export-fill" class="progress-fill"></div>
            </div>
            <div
                style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-tertiary); font-weight:500; margin-bottom:10px;">
                <span id="render-info">60 FPS</span>
                <span id="render-pct">0%</span>
            </div>
            <!-- æ—¶é—´ä¿¡æ¯è¡Œ -->
            <div
                style="display:flex; justify-content:space-between; align-items:center; font-size:12px; font-weight:600; margin-bottom:16px; background:var(--fill-secondary); padding:8px 12px; border-radius:var(--radius-md);">
                <span style="color:var(--text-secondary)">â± å·²ç”¨æ—¶</span>
                <span id="render-elapsed"
                    style="color:var(--text-primary); font-family:monospace; font-size:14px;">00:00</span>
                <span style="color:var(--text-tertiary)">|</span>
                <span style="color:var(--text-secondary)">å‰©ä½™</span>
                <span id="render-eta" style="color:var(--blue); font-family:monospace; font-size:14px;">--:--</span>
            </div>
            <div
                style="background:var(--blue-light); color:var(--blue); padding:14px 16px; border-radius:var(--radius-lg); font-size:13px; line-height:1.5; text-align:left; border:1px solid rgba(0,113,227,0.15);">
                <b style="font-weight:600;">â˜¢ï¸ æ ¸å¼¹çº§åŠ¨ç”»ä¿®å¤</b><br>
                1. æš´åŠ›é€’å½’æ³¨å…¥ Animation å±æ€§<br>
                2. 8K è¶…é‡‡æ · (4320Ã—7560)<br>
                3. ç¡®ä¿ä»»ä½•ä»£ç éƒ½èƒ½åŠ¨ï¼
            </div>
            <button class="btn-sec" onclick="App.stopExport()"
                style="margin-top:20px; color:var(--red); font-weight:600;">å–æ¶ˆ</button>
        </div>
    </div>




    <div id="sidebar">
        <div class="sidebar-header">
            <!-- Page Navigation -->
            <div class="page-nav-bar">
                <a class="page-nav-item active" href="Echart.html">ğŸ¬ è§†é¢‘å¯¼å‡º</a>
                <a class="page-nav-item" href="table.html">ğŸ“¸ å›¾ç‰‡å¯¼å‡º</a>
                <a class="page-nav-item" href="zhozhuanzhang.html">ğŸ“ çŸ©å½¢ç”Ÿæˆ</a>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                <h1>è§†é¢‘å¯¼å‡º</h1>
            </div>
        </div>

        <div style="overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 6px; padding: 6px 0;"
            class="sidebar-scroll">

            <div class="control-section">
                <a href="https://echarts.apache.org/examples/zh/index.html" target="_blank" rel="noopener"
                    style="font-size:12px; color:var(--blue); display:inline-block;">åœ¨å®˜ç½‘æµè§ˆæ›´å¤šç¤ºä¾‹ â†’</a>
            </div>

            <div class="control-section">
                <div class="switch-row">
                    <h2 style="margin:0;">æ ‡é¢˜è®¾ç½®</h2>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label style="margin:0; font-size:12px; color:var(--text-secondary);">æ˜¾ç¤º</label>
                        <label class="toggle">
                            <input type="checkbox" id="title-show" onchange="App.runCode(false)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="col"><label>æ ‡é¢˜æ–‡å­— (åŒæ­¥æ–‡ä»¶å)</label><input type="text" id="title-text" value="2024 Q1 è¥æ”¶æ•°æ®"
                        oninput="App.onTitleChange(this.value)" style="font-weight:600; color:var(--blue);"></div>
                <div class="row">
                    <div class="col"><label>å¤§å°</label><input type="range" id="title-size" min="20" max="200" step="2"
                            value="48" oninput="App.runCode(false)"></div>
                    <div class="col"><label>å‚ç›´ä½ç½®</label><input type="range" id="title-top" min="2" max="30" step="1"
                            value="6" oninput="App.runCode(false)"></div>
                </div>
            </div>

            <div class="control-section">
                <h2>ç”»å¸ƒä¸åŠ¨ç”»</h2>
                <div class="row">
                    <div class="col" style="flex:2">
                        <label>å°ºå¯¸</label>
                        <select id="canvas-preset" onchange="App.applyPreset()">
                            <option value="1080,1890" selected>ğŸ“± 8:14 ç«–å±ï¼ˆé»˜è®¤ï¼‰</option>
                            <option value="1080,1920">ğŸµ 9:16 ç«–å±</option>
                            <option value="1920,1080">ğŸ“º 16:9 æ¨ªå±</option>
                            <option value="1080,1080">â¬œ 1:1 æ­£æ–¹å½¢</option>
                        </select>
                    </div>
                    <div class="col"><label>æ—¶é•¿(s)</label><input type="number" id="anim-duration" value="1.0" step="0.5"
                            onchange="App.runCode(false)"></div>
                </div>
                <div class="row">
                    <div class="col"><label>é€Ÿåº¦æ›²çº¿</label><select id="anim-easing" onchange="App.runCode(false)">
                            <option value="cubicOut" selected>ğŸƒ æŸ”å’Œå‡é€Ÿ</option>
                            <option value="linear">â– çº¿æ€§åŒ€é€Ÿ</option>
                            <option value="quinticOut">ğŸš€ æé€Ÿå†²åˆº</option>
                            <option value="sineInOut">ğŸ¦¢ ä¸æ»‘Så‹</option>
                        </select></div>
                </div>
            </div>

            <div class="control-section">
                <h2>è§†è§‰ç¼©æ”¾</h2>
                <div class="row">
                    <div class="col"><label>å…¨å±€å­—å·</label><input type="range" id="font-scale" min="0.5" max="4.0"
                            step="0.1" value="1.0" oninput="App.updateScale()"></div>
                    <div class="col"><label style="color:var(--blue)">æ ‡ç­¾å¤§å°</label><input type="range" id="tip-scale"
                            min="0.5" max="4.0" step="0.1" value="1.0" oninput="App.updateScale()"></div>
                </div>
            </div>

            <div class="control-section">
                <h2>å¯¼å‡ºä¸å‚æ•°</h2>
                <div class="col"><label class="label" style="margin-bottom:4px;">å¯¼å‡ºæ–‡ä»¶åï¼ˆä¸æ ‡é¢˜åŒæ­¥ï¼‰</label><input type="text"
                        id="file-name" value="Chart_Export" oninput="App.syncTitleAndFileName(this.value, false)"
                        style="font-weight:600; color:var(--text-primary); text-align:center;"></div>
                <div class="row" style="margin-top:5px;">
                    <div class="col"><select id="export-fps" onchange="App.updateExportBtnText()">
                            <option value="60" selected>ğŸš€ 60 FPS (ä¸æ»‘)</option>
                            <option value="30">ğŸ“º 30 FPS (æ ‡å‡†)</option>
                            <option value="25">ğŸï¸ 25 FPS (ç”µå½±)</option>
                        </select></div>
                    <div class="col"><button class="btn-sec" id="btn-capture" onclick="App.captureSmart()">ğŸ“¸ 4K
                            æˆªå›¾</button></div>
                </div>
                <div class="row"><button class="btn-main btn-success" id="btn-export"
                        onclick="App.startCinemaExport()">ğŸ“¦ å¯¼å‡ºè§†é¢‘åºåˆ— (60å¸§)</button></div>
            </div>

            <div class="control-section" style="flex:1; gap:8px; margin-bottom:12px;">
                <div class="row" style="justify-content:space-between; align-items:center; margin:0;">
                    <h2 style="margin:0;">JavaScript</h2><a href="#" onclick="App.resetCode(); return false;"
                        style="font-size:12px; font-weight:500;">æ¸…ç©º</a>
                </div>
                <button class="btn-main" onclick="App.runCode(true)">â–¶ è¿è¡Œä»£ç  & æ™ºèƒ½å‘½å</button>
                <textarea id="code-area" spellcheck="false"></textarea>
                <div id="code-status"></div>
            </div>
        </div>
    </div>

    <div id="preview-stage">
        <div id="chart-container"></div>
    </div>

    <script>
        window.App = {
            chart: null, isExporting: false, isFrozen: false,
            _lastHover: null,
            state: { width: 1080, height: 1890, fontScale: 1.0, tipScale: 1.0, viewScale: 0.45, viewX: 0, viewY: 0 },

            initChart() {
                const dom = document.getElementById('chart-container');
                if (!dom || typeof echarts === 'undefined') return;
                this.chart = echarts.init(dom, null, { renderer: 'canvas', devicePixelRatio: 2 });
                this.chart.on('mousemove', (params) => {
                    if (params && params.componentType === 'series' && params.seriesIndex != null && params.dataIndex != null)
                        this._lastHover = { seriesIndex: params.seriesIndex, dataIndex: params.dataIndex };
                });
            },

            init() {
                this.initChart();
                const defaultCode = `option = {\n  xAxis: {\n    type: 'category',\n    data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']\n  },\n  yAxis: {\n    type: 'value'\n  },\n  series: [\n    {\n      data: [120, 200, 150, 80, 70, 110, 130],\n      type: 'bar'\n    }\n  ]\n};`;
                // å§‹ç»ˆä½¿ç”¨é»˜è®¤æ¨¡æ¿ä»£ç ï¼Œæ–¹ä¾¿é¢„è§ˆ
                document.getElementById('code-area').value = defaultCode;
                this.applyPreset(); this.updateExportBtnText(); this.initCanvasControl();
                window.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 'Enter') this.runCode(true); });
                // å…¨å±€æŒ‰é’®æ¶Ÿæ¼ªåé¦ˆ
                document.addEventListener('click', (e) => {
                    const btn = e.target.closest('.btn-main, .btn-sec, .zoom-btn');
                    if (!btn) return;
                    const rect = btn.getBoundingClientRect();
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    ripple.style.left = (e.clientX - rect.left) + 'px';
                    ripple.style.top = (e.clientY - rect.top) + 'px';
                    btn.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 550);
                });

                // åŒå‡»é¢„è§ˆåŒºåŸŸæˆ–å›¾è¡¨å®¹å™¨ï¼Œåˆ‡æ¢å†»ç»“ / è§£å†»ç”»é¢ï¼ˆä¿ç•™å½“å‰æ ‡ç­¾çŠ¶æ€ï¼‰
                const chartContainer = document.getElementById('chart-container');
                if (chartContainer) {
                    chartContainer.addEventListener('dblclick', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.toggleFreeze();
                    }, true);
                }
                const preview = document.getElementById('preview-stage');
                if (preview) {
                    preview.ondblclick = (e) => {
                        // åªåœ¨ç‚¹å‡»ç©ºç™½é¢„è§ˆåŒºåŸŸæ—¶æ‰è§¦å‘ï¼Œé¿å…è¯¯è§¦å…¶å®ƒæ§ä»¶
                        if (e.target === preview) {
                            e.preventDefault();
                            this.toggleFreeze();
                        }
                    };
                }
            },


            _deepseekMode: 'common',

            setDeepSeekMode(mode) {
                this._deepseekMode = mode === 'custom' ? 'custom' : 'common';
                const block = document.getElementById('deepseek-custom-template-block');
                const tabCommon = document.getElementById('deepseek-tab-common');
                const tabCustom = document.getElementById('deepseek-tab-custom');
                if (block) block.style.display = this._deepseekMode === 'custom' ? 'block' : 'none';
                if (tabCommon) tabCommon.classList.toggle('active', this._deepseekMode === 'common');
                if (tabCustom) tabCustom.classList.toggle('active', this._deepseekMode === 'custom');
            },

            openDeepSeekModal() {
                const modal = document.getElementById('deepseek-modal');
                if (!modal) return;
                modal.style.display = 'flex';
                this.setDeepSeekMode(this._deepseekMode || 'common');
                const key = sessionStorage.getItem('deepseek_api_key');
                const keyEl = document.getElementById('deepseek-api-key');
                if (keyEl && key) keyEl.value = key;
                const resultEl = document.getElementById('deepseek-result');
                const statusEl = document.getElementById('deepseek-status');
                const applyBtn = document.getElementById('deepseek-apply-btn');
                if (resultEl) resultEl.value = '';
                if (statusEl) statusEl.textContent = '';
                if (applyBtn) applyBtn.disabled = true;
                this.clearDeepSeekImage();
                const templateEl = document.getElementById('deepseek-template');
                if (templateEl) {
                    try {
                        const saved = localStorage.getItem('deepseek_template_code');
                        if (saved) templateEl.value = saved;
                    } catch (e) { }
                }
                const imgInput = document.getElementById('deepseek-image');
                if (imgInput && !imgInput._bound) {
                    imgInput._bound = true;
                    imgInput.addEventListener('change', () => {
                        const nameEl = document.getElementById('deepseek-image-name');
                        const clearBtn = document.getElementById('deepseek-image-clear');
                        if (imgInput.files && imgInput.files[0]) {
                            if (nameEl) nameEl.textContent = imgInput.files[0].name;
                            if (clearBtn) clearBtn.style.display = 'inline-block';
                        } else {
                            if (nameEl) nameEl.textContent = '';
                            if (clearBtn) clearBtn.style.display = 'none';
                        }
                    });
                }
            },

            clearDeepSeekImage() {
                const imgInput = document.getElementById('deepseek-image');
                if (!imgInput) return;
                imgInput.value = '';
                const nameEl = document.getElementById('deepseek-image-name');
                const clearBtn = document.getElementById('deepseek-image-clear');
                if (nameEl) nameEl.textContent = '';
                if (clearBtn) clearBtn.style.display = 'none';
            },

            /** ä» AI è¿”å›æ–‡æœ¬ä¸­æå– option = { ... }; æ”¯æŒåµŒå¥—å¤§æ‹¬å· */
            extractOptionCode(text) {
                if (!text || typeof text !== 'string') return '';
                const start = text.search(/\boption\s*=\s*\{/);
                if (start < 0) return '';
                let i = text.indexOf('{', text.indexOf('=', start));
                if (i < 0) return '';
                let depth = 1;
                for (i += 1; i < text.length && depth > 0; i++) {
                    const c = text[i];
                    if (c === '{') depth++;
                    else if (c === '}') depth--;
                }
                let end = i;
                while (end < text.length && (text[end] === ';' || /\s/.test(text[end]))) end++;
                const code = text.slice(start, end).trim();
                return code.endsWith(';') ? code : code + ';';
            },

            /** å°†æ–‡ä»¶è¯»å–ä¸º DataURLï¼ˆPromise å°è£…ï¼‰*/
            readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const result = reader.result;
                        const mime = (file.type || 'image/jpeg').toLowerCase();
                        const dataUrl = result.indexOf('base64,') >= 0 ? result : 'data:' + mime + ';base64,' + result;
                        resolve(dataUrl);
                    };
                    reader.onerror = () => reject(new Error('å›¾ç‰‡è¯»å–å¤±è´¥'));
                    reader.readAsDataURL(file);
                });
            },

            closeDeepSeekModal() {
                const modal = document.getElementById('deepseek-modal');
                if (modal) modal.style.display = 'none';
            },

            saveDeepSeekTemplate() {
                const templateEl = document.getElementById('deepseek-template');
                const statusEl = document.getElementById('deepseek-status');
                if (!templateEl) return;
                const code = templateEl.value.trim();
                try {
                    if (code) {
                        localStorage.setItem('deepseek_template_code', code);
                        if (statusEl) { statusEl.textContent = 'æ¨¡æ¿å·²ä¿å­˜åˆ°æœ¬åœ°'; statusEl.style.color = 'var(--green)'; }
                    } else {
                        localStorage.removeItem('deepseek_template_code');
                        if (statusEl) { statusEl.textContent = 'å·²æ¸…ç©ºä¿å­˜çš„æ¨¡æ¿'; statusEl.style.color = 'var(--text-tertiary)'; }
                    }
                } catch (e) {
                    if (statusEl) { statusEl.textContent = 'ä¿å­˜å¤±è´¥: ' + (e.message || e); statusEl.style.color = 'var(--red)'; }
                }
            },

            /* Chat UI helpers */
            appendChatMessage(role, text) {
                const wrap = document.getElementById('deepseek-chat-messages');
                if (!wrap) return;
                const el = document.createElement('div');
                el.className = 'deepseek-chat-msg ' + (role === 'user' ? 'user' : (role === 'assistant' ? 'assistant' : ''));
                el.setAttribute('data-role', role);

                // meta (role + time)
                const meta = document.createElement('div');
                meta.className = 'meta';
                const roleLabel = document.createElement('div');
                roleLabel.className = 'role';
                roleLabel.textContent = role === 'user' ? 'ä½ ' : (role === 'assistant' ? 'AI' : role);
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time';
                const now = new Date();
                timeLabel.textContent = now.toLocaleTimeString();
                meta.appendChild(roleLabel);
                meta.appendChild(timeLabel);
                el.appendChild(meta);

                // content
                const content = document.createElement('div');
                content.className = 'content';
                content.textContent = text;
                el.appendChild(content);

                // actions for assistant messages
                if (role === 'assistant') {
                    const actions = document.createElement('div');
                    actions.className = 'actions';
                    const applyBtn = document.createElement('button');
                    applyBtn.className = 'btn-sec';
                    applyBtn.textContent = 'åº”ç”¨';
                    applyBtn.onclick = () => this.applyAssistantText(text);
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'btn-sec';
                    copyBtn.textContent = 'å¤åˆ¶';
                    copyBtn.onclick = () => this.copyToClipboard(text);
                    actions.appendChild(copyBtn);
                    actions.appendChild(applyBtn);
                    el.appendChild(actions);
                }

                wrap.appendChild(el);
                // scroll to bottom
                const area = document.getElementById('deepseek-chat-area');
                if (area) area.scrollTop = area.scrollHeight;
            },

            insertTemplateToChat() {
                const tpl = document.getElementById('deepseek-template');
                const input = document.getElementById('deepseek-chat-input');
                if (!tpl || !input) return;
                const t = tpl.value || '';
                if (!t) return;
                input.value = (input.value ? input.value + '\\n\\n' : '') + t;
                input.focus();
            },

            async sendChatMessage() {
                const apiKey = document.getElementById('deepseek-api-key').value.trim();
                const model = document.getElementById('deepseek-model').value || 'deepseek-chat';
                const systemPrompt = document.getElementById('deepseek-system').value.trim();
                const inputEl = document.getElementById('deepseek-chat-input');
                const imageInput = document.getElementById('deepseek-image');
                const statusEl = document.getElementById('deepseek-status');
                if (!apiKey) { if (statusEl) { statusEl.textContent = 'è¯·å…ˆå¡«å†™ API Key'; statusEl.style.color = 'var(--red)'; } return; }
                const userText = inputEl && inputEl.value.trim();
                const imageFile = imageInput && imageInput.files && imageInput.files[0];
                if (!userText && !imageFile) { if (statusEl) { statusEl.textContent = 'è¯·è¾“å…¥å†…å®¹æˆ–ä¸Šä¼ å›¾ç‰‡'; statusEl.style.color = 'var(--red)'; } return; }

                // append user message
                if (userText) this.appendChatMessage('user', userText);
                inputEl.value = '';
                if (statusEl) { statusEl.textContent = 'æ­£åœ¨è¯·æ±‚ ' + model + '...'; statusEl.style.color = 'var(--text-secondary)'; }

                let userContent;
                if (imageFile) {
                    const dataUrl = await this.readFileAsDataURL(imageFile);
                    userContent = [
                        { type: 'text', text: userText || '' },
                        { type: 'image_url', image_url: { url: dataUrl } }
                    ];
                } else {
                    userContent = userText;
                }

                try {
                    const res = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                ...(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []),
                                { role: 'user', content: userContent }
                            ],
                            max_tokens: 4096,
                            temperature: 0.3
                        })
                    });
                    const data = await res.json();
                    if (data.error) {
                        if (statusEl) { statusEl.textContent = 'API é”™è¯¯: ' + (data.error.message || JSON.stringify(data.error)); statusEl.style.color = 'var(--red)'; }
                        return;
                    }
                    let text = (data.choices?.[0]?.message?.content || '').trim();
                    if (!text) text = (data.choices?.[0]?.text || '').trim();
                    if (!text) text = '[æ— è¿”å›å†…å®¹]';
                    this.appendChatMessage('assistant', text);
                    if (statusEl) { statusEl.textContent = 'å·²æ”¶åˆ°å›å¤'; statusEl.style.color = 'var(--green)'; }
                } catch (e) {
                    if (statusEl) { statusEl.textContent = 'è¯·æ±‚å¤±è´¥: ' + (e.message || e); statusEl.style.color = 'var(--red)'; }
                }
            },

            applyLastAssistantMessage() {
                const wrap = document.getElementById('deepseek-chat-messages');
                if (!wrap) return;
                const children = Array.from(wrap.children).reverse();
                const assistant = children.find(c => c.getAttribute('data-role') === 'assistant');
                if (!assistant) return;
                const text = assistant.innerText || assistant.textContent || '';
                const extracted = this.extractOptionCode(text);
                const codeToApply = extracted || text;
                const codeArea = document.getElementById('code-area');
                if (!codeArea) return;
                codeArea.value = codeToApply;
                this.runCode(true);
                this.closeDeepSeekModal();
            },

            applyAssistantText(text) {
                const extracted = this.extractOptionCode(text);
                const codeToApply = extracted || text;
                const codeArea = document.getElementById('code-area');
                if (!codeArea) return;
                codeArea.value = codeToApply;
                this.runCode(true);
                this.closeDeepSeekModal();
            },

            copyToClipboard(text) {
                try {
                    if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text);
                    } else {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                    }
                    const statusEl = document.getElementById('deepseek-status');
                    if (statusEl) { statusEl.textContent = 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'; statusEl.style.color = 'var(--green)'; setTimeout(() => statusEl.textContent = '', 1200); }
                } catch (e) {
                    console.warn('å¤åˆ¶å¤±è´¥', e);
                }
            },

            clearChat() {
                const wrap = document.getElementById('deepseek-chat-messages');
                if (wrap) wrap.innerHTML = '';
                const statusEl = document.getElementById('deepseek-status');
                if (statusEl) statusEl.textContent = '';
            },

            openDeepSeekTemplates() {
                const tpl = document.getElementById('deepseek-template');
                if (tpl) tpl.focus();
            },

            async generateCodeWithDeepSeek() {
                const apiKey = document.getElementById('deepseek-api-key').value.trim();
                const userData = document.getElementById('deepseek-data').value.trim();
                const chartType = document.getElementById('deepseek-chart-type').value;
                const imageInput = document.getElementById('deepseek-image');
                const imageFile = imageInput.files && imageInput.files[0];
                const statusEl = document.getElementById('deepseek-status');
                const resultEl = document.getElementById('deepseek-result');
                const btn = document.getElementById('deepseek-generate-btn');
                const applyBtn = document.getElementById('deepseek-apply-btn');

                if (!apiKey) { statusEl.textContent = 'è¯·å…ˆå¡«å†™ API Key'; statusEl.style.color = 'var(--red)'; return; }
                const isCustomMode = this._deepseekMode === 'custom';
                const hasTemplate = document.getElementById('deepseek-template').value.trim();
                if (!userData && !imageFile && !(isCustomMode && hasTemplate)) { statusEl.textContent = 'è¯·å¡«å†™æ•°æ®ã€ä¸Šä¼ å›¾ç‰‡ï¼Œæˆ–ï¼ˆè‡ªå®šä¹‰æ¨¡å¼ä¸‹ï¼‰å¡«å†™ä¸Šæ–¹ä»£ç '; statusEl.style.color = 'var(--red)'; return; }

                if (apiKey) sessionStorage.setItem('deepseek_api_key', apiKey);

                btn.disabled = true;
                applyBtn.disabled = true;
                resultEl.value = '';
                statusEl.textContent = imageFile ? 'æ­£åœ¨è¯†åˆ«å›¾ç‰‡å¹¶ç”Ÿæˆä»£ç ...' : 'æ­£åœ¨è¯·æ±‚ DeepSeek...';
                statusEl.style.color = 'var(--text-secondary)';

                const templateCode = document.getElementById('deepseek-template').value.trim();
                const isCustom = this._deepseekMode === 'custom';

                const systemPromptText = 'ä½ æ˜¯ä¸€ä¸ª ECharts å›¾è¡¨é…ç½®ä¸“å®¶ã€‚æ ¹æ®ç”¨æˆ·æä¾›çš„æ•°æ®å’Œ/æˆ–å›¾ç‰‡ï¼Œåªè¾“å‡ºä¸€æ®µå¯è¿è¡Œçš„ JavaScript ä»£ç ï¼Œä¸”å¿…é¡»æ»¡è¶³ï¼š' +
                    '1) ä»£ç ä¸­åªå®šä¹‰ä¸€ä¸ªå˜é‡ optionï¼Œå³ option = { ... };  ' +
                    '2) ä½¿ç”¨ ECharts 5 çš„é…ç½®é¡¹ï¼Œä¸è¦ä½¿ç”¨ echarts.init ç­‰ï¼Œåªç»™ option å¯¹è±¡ï¼›' +
                    '3) è‹¥ç”¨æˆ·æä¾›çš„æ˜¯å›¾ç‰‡ï¼Œè¯·è¯†åˆ«å›¾ç‰‡ä¸­çš„å›¾è¡¨ç±»å‹ã€åæ ‡è½´ã€æ•°æ®ç‚¹æˆ–è¡¨æ ¼å†…å®¹ï¼Œå¹¶æ®æ­¤ç”Ÿæˆ optionï¼›' +
                    '4) è‹¥ç”¨æˆ·æ•°æ®æ˜¯ CSV æˆ–è¡¨æ ¼ï¼Œè¯·è§£æåå¡«å…¥ series.data æˆ– xAxis.dataï¼›' +
                    '5) ä¸è¦è¾“å‡º markdown ä»£ç å—æ ‡è®°ï¼Œåªè¾“å‡ºçº¯ JavaScript çš„ option = { ... }; ä¸€è¡Œæˆ–æ•°è¡Œã€‚è‹¥ç”¨æˆ·æä¾›äº†æ¨¡æ¿ä»£ç ï¼Œè¯·åœ¨å…¶åŸºç¡€ä¸Šç»“åˆæ•°æ®ç”Ÿæˆæœ€ç»ˆ optionã€‚' +
                    '\n\nã€æ•°æ®è§£æé“å¾‹â€”â€”ä¸¥æ ¼éµå®ˆã€‘' +
                    '\nA) åˆ—åˆ†éš”ç¬¦ï¼šå¿…é¡»ä½¿ç”¨ç«–çº¿ "|" ä½œä¸ºåˆ—åˆ†éš”ç¬¦ï¼Œä¸¥ç¦ä½¿ç”¨é€—å·ä½œä¸ºåˆ†éš”ç¬¦ã€‚' +
                    '\nB) åƒåˆ†ä½ä¿æŠ¤ï¼šæ•°å­—ä¸­çš„é€—å·ï¼ˆå¦‚ 500,000 æˆ– 1,234,567ï¼‰æ˜¯åƒåˆ†ä½åˆ†éš”ç¬¦ï¼Œå±äºåŒä¸€ä¸ªæ•°å€¼çš„ä¸€éƒ¨åˆ†ï¼Œç»å¯¹ä¸èƒ½æ‹†å¼€æˆå¤šåˆ—ã€‚åœ¨è¾“å‡ºæ•°æ®æ—¶ä¿ç•™åŸå§‹æ•°å€¼ï¼ˆå»æ‰åƒåˆ†ä½é€—å·ï¼‰ï¼Œä¾‹å¦‚ 500,000 => 500000ã€‚' +
                    '\nC) è¡¥é½è¡Œæ•°æ®ï¼šå¦‚æœæŸè¡Œæ•°æ®ä¸è¶³é¢„æœŸåˆ—æ•°ï¼Œå¿…é¡»ç”¨ "-" æˆ– 0 è¡¥é½ç¼ºå¤±åˆ—ï¼Œç¡®ä¿æ¯è¡Œåˆ—æ•°ä¸€è‡´ã€è¡¨æ ¼ç»“æ„å®Œæ•´ã€‚' +
                    '\nD) æ•°æ®ç±»å‹è‡ªåŠ¨è½¬æ¢ï¼šæ‰€æœ‰çœ‹èµ·æ¥æ˜¯æ•°å­—çš„å­—æ®µï¼ˆå³ä½¿å¸¦æœ‰åƒåˆ†ä½é€—å·æˆ–ç™¾åˆ†å·ï¼‰éƒ½åº”è½¬ä¸ºçº¯æ•°å€¼å¡«å…¥ data æ•°ç»„ã€‚';
                let userContent;
                if (imageFile) {
                    const dataUrl = await this.readFileAsDataURL(imageFile);
                    let textPart = (chartType !== 'è‡ªåŠ¨è¯†åˆ«' ? `ç›®æ ‡å›¾è¡¨ç±»å‹ï¼š${chartType}ã€‚\n\n` : '');
                    if (isCustom && templateCode) textPart += `ã€ç”¨æˆ·æ¨¡æ¿ä»£ç ã€‘\n${templateCode}\n\n`;
                    textPart += (userData ? `ç”¨æˆ·è¡¥å……æ•°æ®æˆ–è¯´æ˜ï¼š\n${userData}\n\n` : '') +
                        'è¯·æ ¹æ®å›¾ç‰‡å†…å®¹ï¼ˆåŠä¸Šè¿°è¯´æ˜ï¼‰ç”Ÿæˆ ECharts çš„ option ä»£ç ï¼ˆä»… option = { ... }; å½¢å¼ï¼‰ã€‚';
                    userContent = [
                        { type: 'text', text: textPart },
                        { type: 'image_url', image_url: { url: dataUrl } }
                    ];
                } else {
                    if (isCustom && templateCode) {
                        userContent = `ç›®æ ‡å›¾è¡¨ç±»å‹ï¼š${chartType}ã€‚\n\nã€ç”¨æˆ·æ¨¡æ¿ä»£ç ï¼ˆä¸Šæ–¹ï¼‰ã€‘\n${templateCode}\n\nã€ç”¨æˆ·æ•°æ®ï¼ˆä¸‹æ–¹ï¼‰ã€‘\n${userData}\n\nè¯·å°†ä¸Šæ–¹ä»£ç ä¸ä¸‹æ–¹æ•°æ®åˆå¹¶ï¼Œåªè¾“å‡ºæœ€ç»ˆå¯è¿è¡Œçš„ option = { ... }; ä¸è¦ markdown æ ‡è®°ã€‚`;
                    } else {
                        userContent = `ç›®æ ‡å›¾è¡¨ç±»å‹ï¼š${chartType}ã€‚\n\nç”¨æˆ·æ•°æ®ï¼š\n${userData}\n\nè¯·æ ¹æ®ä»¥ä¸Šæ•°æ®ç”Ÿæˆ ECharts çš„ option ä»£ç ï¼ˆä»… option = { ... }; å½¢å¼ï¼‰ã€‚`;
                    }
                }

                try {
                    const res = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: [
                                { role: 'system', content: systemPromptText },
                                { role: 'user', content: userContent }
                            ],
                            max_tokens: 4096,
                            temperature: 0.3
                        })
                    });
                    const data = await res.json();
                    if (data.error) {
                        statusEl.textContent = 'API é”™è¯¯: ' + (data.error.message || JSON.stringify(data.error));
                        statusEl.style.color = 'var(--red)';
                        return;
                    }
                    let text = (data.choices?.[0]?.message?.content || '');
                    text = text.trim();
                    const extracted = this.extractOptionCode(text);
                    if (extracted) text = extracted;
                    resultEl.value = text;
                    applyBtn.disabled = !text;
                    statusEl.textContent = 'ç”Ÿæˆå®Œæˆï¼Œå¯ç‚¹å‡»ã€Œåº”ç”¨åˆ°ç¼–è¾‘å™¨ã€';
                    statusEl.style.color = 'var(--green)';
                } catch (e) {
                    statusEl.textContent = 'è¯·æ±‚å¤±è´¥: ' + (e.message || e);
                    statusEl.style.color = 'var(--red)';
                } finally {
                    btn.disabled = false;
                }
            },

            applyGeneratedCode() {
                const resultEl = document.getElementById('deepseek-result');
                const codeArea = document.getElementById('code-area');
                if (!resultEl || !codeArea) return;
                const code = resultEl.value.trim();
                if (!code) return;
                codeArea.value = code;
                this.runCode(true);
                this.closeDeepSeekModal();
            },

            initCanvasControl() {
                const stage = document.getElementById('preview-stage');
                const chartDom = document.getElementById('chart-container');
                let isDragging = false, startX, startY, isSpacePressed = false;

                stage.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.05 : 0.05;
                    this.zoom(delta);
                }, { passive: false });

                window.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && !e.repeat
                        && document.activeElement.tagName !== 'TEXTAREA'
                        && document.activeElement.tagName !== 'INPUT') {
                        isSpacePressed = true;
                        stage.style.cursor = 'grab';
                        chartDom.style.pointerEvents = 'none';
                    }
                });

                window.addEventListener('keyup', (e) => {
                    if (e.code === 'Space') {
                        isSpacePressed = false;
                        stage.style.cursor = 'default';
                        chartDom.style.pointerEvents = 'auto';
                    }
                });

                stage.addEventListener('mousedown', (e) => {
                    const canDrag = e.button === 1
                        || (e.button === 0 && isSpacePressed)
                        || (e.button === 0 && e.target === stage);
                    if (canDrag) {
                        isDragging = true;
                        startX = e.clientX - this.state.viewX;
                        startY = e.clientY - this.state.viewY;
                        stage.style.cursor = 'grabbing';
                        e.preventDefault();
                    }
                });

                window.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    this.state.viewX = e.clientX - startX;
                    this.state.viewY = e.clientY - startY;
                    this.updateTransform();
                });

                window.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        stage.style.cursor = isSpacePressed ? 'grab' : 'default';
                    }
                });
            },

            zoom(delta) {
                const newScale = Math.min(5, Math.max(0.05, this.state.viewScale + delta));
                this.state.viewScale = newScale;
                this.updateTransform();
            },

            resetZoom() {
                this.state.viewScale = 1;
                this.state.viewX = 0;
                this.state.viewY = 0;
                this.updateTransform();
            },

            autoFit() {
                const wrap = document.getElementById('preview-stage');
                const scale = Math.min(
                    (wrap.clientWidth - 80) / this.state.width,
                    (wrap.clientHeight - 80) / this.state.height
                );
                this.state.viewScale = scale;
                this.state.viewX = 0;
                this.state.viewY = 0;
                this.updateTransform();
            },

            updateTransform() {
                const dom = document.getElementById('chart-container');
                dom.style.transform = `translate(${this.state.viewX}px, ${this.state.viewY}px) scale(${this.state.viewScale})`;
                document.getElementById('zoom-level').innerText = Math.round(this.state.viewScale * 100) + '%';
            },

            updateExportBtnText() {
                const fps = document.getElementById('export-fps').value;
                document.getElementById('btn-export').innerText = `ğŸ“¦ å¯¼å‡ºè§†é¢‘åºåˆ— (${fps}å¸§)`;
            },
            onTitleChange(val) { this.syncTitleAndFileName(val, true); this.runCode(false); },
            /** åŒæ­¥æ ‡é¢˜ä¸å¯¼å‡ºåï¼šsource ä¸ºå½“å‰å€¼ï¼ŒfromTitle ä¸º true è¡¨ç¤ºæ¥æºæ˜¯æ ‡é¢˜æ¡†ï¼ˆå¯¼å‡ºåç”¨ sanitizeï¼‰ï¼Œfalse è¡¨ç¤ºæ¥æºæ˜¯å¯¼å‡ºåæ¡†ï¼ˆæ ‡é¢˜è·Ÿä»ï¼Œå¯¼å‡ºåä¸æ”¹å†™ï¼‰ */
            syncTitleAndFileName(source, fromTitle) {
                const titleEl = document.getElementById('title-text');
                const fileEl = document.getElementById('file-name');
                if (!titleEl || !fileEl) return;
                if (this._syncingTitleFile) return;
                this._syncingTitleFile = true;
                const safe = (s) => (s || '').replace(/[\\/:*?"<>|]/g, '_').trim() || 'Chart_Export';
                if (fromTitle) {
                    const safeName = safe(source);
                    fileEl.value = safeName;
                    titleEl.value = source == null ? '' : (source || '');
                } else {
                    const v = source == null ? '' : (source || '');
                    titleEl.value = v;
                }
                this._syncingTitleFile = false;
            },
            updateFileName(name) { this.syncTitleAndFileName(name, true); },
            /** æ ¹æ® series ç±»å‹æ¨æ–­ tooltip.triggerï¼šé¥¼å›¾/ä»ªè¡¨ç›˜ç­‰ç”¨ itemï¼Œå¦åˆ™ç”¨ axis */
            inferTooltipTrigger(option) {
                const series = option.series;
                if (!series || !Array.isArray(series) || series.length === 0) return 'axis';
                const types = series.map(s => (s && s.type) ? s.type : '');
                const needItem = ['pie', 'gauge', 'funnel', 'sankey', 'tree', 'treemap', 'sunburst', 'graph', 'lines', 'map'].some(t => types.includes(t));
                if (needItem) return 'item';
                const allScatter = types.every(t => t === 'scatter' || t === 'effectScatter');
                const hasCategoryAxis = [].concat(option.xAxis || []).some(ax => ax && ax.type === 'category');
                if (allScatter && !hasCategoryAxis) return 'item';
                return 'axis';
            },
            getExportFileName() {
                const fileEl = document.getElementById('file-name');
                const raw = (fileEl && fileEl.value) ? fileEl.value.trim() : '';
                return raw.replace(/[\\/:*?"<>|]/g, '_').trim() || 'Chart_Export';
            },

            // --- V108: æ ¸å¼¹çº§é€’å½’æ³¨å…¥ ---
            forceAnimation(obj, duration, easing) {
                if (typeof obj !== 'object' || obj === null) return;
                obj.animation = true;
                obj.animationDuration = duration;
                obj.animationDurationUpdate = duration;
                if (easing) {
                    obj.animationEasing = easing;
                    obj.animationEasingUpdate = easing;
                }
                // é€’å½’æ³¨å…¥ (å‡»ç©¿æ‰€æœ‰ series, graphic, dataset)
                for (const key in obj) {
                    const val = obj[key];
                    if (val && typeof val === 'object' && !Array.isArray(val)) {
                        this.forceAnimation(val, duration, easing);
                    } else if (Array.isArray(val)) {
                        val.forEach(item => this.forceAnimation(item, duration, easing));
                    }
                }
            },

            runCode: function (isFullReset = false, slowFactor = 1) {
                const codeEl = document.getElementById('code-area');
                if (!codeEl || !this.chart) return;
                try {
                    const code = codeEl.value;
                    if (typeof localStorage !== 'undefined') localStorage.setItem('echarts_shared_code', code);
                    if (!code || !code.trim()) return;
                    let option;
                    const func = new Function(`
                        var option; 
                        ${code}
                        return option;
                    `);
                    option = func();
                    if (!option || typeof option !== 'object') {
                        console.warn('runCode: option æœªå®šä¹‰æˆ–éå¯¹è±¡');
                        return;
                    }

                    if (isFullReset) {
                        let autoName = "Chart_Export";
                        if (option.title && option.title.text) autoName = option.title.text;
                        else if (option.series && option.series[0] && option.series[0].name) autoName = option.series[0].name;
                        this.syncTitleAndFileName(autoName, true);
                    }

                    if (!option.backgroundColor || option.backgroundColor === 'auto') { option.backgroundColor = '#ffffff'; }

                    const userDur = parseFloat(document.getElementById('anim-duration').value) * 1000;
                    const realDur = userDur * slowFactor;
                    const ease = document.getElementById('anim-easing').value;

                    // V108: è°ƒç”¨æ ¸å¼¹æ³¨å…¥
                    // å¦‚æœæ˜¯æ…¢æ”¾æ¨¡å¼ (å¯¼å‡ºä¸­)ï¼Œåˆ™å¼ºåŠ›è¦†ç›–æ‰€æœ‰åŠ¨ç”»å‚æ•°
                    if (slowFactor > 1) {
                        this.forceAnimation(option, realDur, ease);
                    } else {
                        // æ™®é€šæ¨¡å¼ï¼Œåªè¦†ç›–é¡¶å±‚ï¼Œå…è®¸ç”¨æˆ·ä»£ç å†…éƒ¨è‡ªç”±å‘æŒ¥
                        option.animationDuration = realDur;
                        option.animationEasing = ease;
                        if (option.series) option.series.forEach(s => { s.animationDuration = realDur; s.animationEasing = ease; });
                    }

                    this.deepScale(option);
                    this.applyGlobalFontScale(option);

                    if (!option.title) option.title = {};
                    const showTitle = document.getElementById('title-show').checked;
                    option.title.show = showTitle;

                    if (showTitle) {
                        const titleText = document.getElementById('title-text').value;
                        if (titleText) option.title.text = titleText;
                        const titleSize = parseInt(document.getElementById('title-size').value);
                        if (!option.title.textStyle) option.title.textStyle = {};
                        option.title.textStyle.fontSize = titleSize;
                        const titleTop = document.getElementById('title-top').value;
                        option.title.top = titleTop + '%';
                        option.title.left = 'center';
                    }

                    // å§‹ç»ˆä¿è¯æ‚¬åœæœ‰æç¤ºï¼šç”¨æˆ·æœªé…ç½®æ—¶ç»™é»˜è®¤ tooltipï¼Œå¹¶ä¼˜åŒ–æ˜¾ç¤ºç¨³å®šæ€§
                    if (!option.tooltip) option.tooltip = {};
                    if (!option.tooltip.textStyle) option.tooltip.textStyle = {};
                    let base = option.tooltip.textStyle.fontSize || 28;
                    option.tooltip.textStyle.fontSize = Math.max(14, Math.round(base * this.state.tipScale));
                    option.tooltip.confine = true;
                    option.tooltip.appendToBody = false;
                    option.tooltip.show = true;
                    option.tooltip.triggerDelay = 0;
                    option.tooltip.transitionDuration = 0.15;
                    option.tooltip.hideDelay = 100;
                    option.tooltip.enterable = true;
                    if (this.isFrozen) { option.tooltip.alwaysShowContent = true; option.tooltip.triggerOn = 'none'; }
                    else { option.tooltip.alwaysShowContent = false; option.tooltip.triggerOn = 'mousemove|click'; }
                    if (option.tooltip.trigger == null || option.tooltip.trigger === undefined)
                        option.tooltip.trigger = this.inferTooltipTrigger(option);
                    if (option.tooltip.trigger === 'axis') {
                        if (!option.tooltip.axisPointer) option.tooltip.axisPointer = {};
                        if (option.tooltip.axisPointer.show === undefined) option.tooltip.axisPointer.show = true;
                    }

                    if (isFullReset) this.chart.clear();
                    this.chart.setOption(option, { notMerge: isFullReset });

                    const statusEl = document.getElementById('code-status');
                    if (statusEl) { statusEl.textContent = ''; statusEl.style.color = ''; }
                } catch (e) {
                    console.error(e);
                    const statusEl = document.getElementById('code-status');
                    if (statusEl) {
                        statusEl.textContent = 'è¿è¡Œå¤±è´¥: ' + (e && e.message ? e.message : String(e));
                        statusEl.style.color = 'var(--red)';
                    }
                }
            },

            async captureSmart() {
                const btn = document.getElementById('btn-capture') || document.querySelector('button[onclick*="captureSmart"]');
                const old = btn.innerText; btn.innerText = "é«˜æ¸…æˆªå›¾ä¸­..."; btn.disabled = true;
                const fileName = this.getExportFileName();
                const dom = document.getElementById('chart-container');

                // â”€â”€ ä¸´æ—¶å…³é—­åŠ¨ç”»ï¼Œè®©å›¾è¡¨ç¬é—´å¤„äºæœ€ç»ˆçŠ¶æ€ â”€â”€
                const currentOpt = this.chart.getOption();
                const bg = currentOpt.backgroundColor && currentOpt.backgroundColor !== 'auto' ? currentOpt.backgroundColor : '#ffffff';
                this.chart.setOption({ animation: false }, { notMerge: false });

                // â”€â”€ ç­‰å¾… ECharts æ¸²æŸ“å®Œæˆï¼ˆfinished äº‹ä»¶ + 300ms åŒé‡ä¿é™©ï¼‰â”€â”€
                await new Promise(resolve => {
                    const onFinish = () => {
                        this.chart.off('finished', onFinish);
                        setTimeout(resolve, 300);
                    };
                    this.chart.on('finished', onFinish);
                    // é˜²æ­¢ finished ä¸è§¦å‘ï¼ˆå›¾è¡¨å·²æ˜¯ç»ˆæ€æ—¶ï¼‰ï¼ŒåŠ è¶…æ—¶å…œåº•
                    setTimeout(() => { this.chart.off('finished', onFinish); resolve(); }, 1000);
                });

                try {
                    if (this.isFrozen) {
                        const savedTransform = dom.style.transform;
                        const savedPosition = dom.style.position;
                        const savedLeft = dom.style.left;
                        const savedTop = dom.style.top;
                        const savedZIndex = dom.style.zIndex;
                        dom.style.transform = 'none';
                        dom.style.position = 'fixed';
                        dom.style.left = '-99999px';
                        dom.style.top = '0';
                        dom.style.zIndex = '99999';
                        await new Promise(r => requestAnimationFrame(r));
                        const canvas = await html2canvas(dom, {
                            scale: 3, backgroundColor: bg, logging: false, useCORS: true,
                            width: this.state.width, height: this.state.height
                        });
                        dom.style.transform = savedTransform;
                        dom.style.position = savedPosition;
                        dom.style.left = savedLeft;
                        dom.style.top = savedTop;
                        dom.style.zIndex = savedZIndex;
                        canvas.toBlob(blob => saveAs(blob, `${fileName}.png`));
                    } else {
                        // pixelRatio: 3 é«˜æ¸…å¯¼å‡º
                        const dataUrl = this.chart.getDataURL({
                            type: 'png', pixelRatio: 3, backgroundColor: bg, excludeComponents: ['toolbox']
                        });
                        const base64 = dataUrl.split(',')[1];
                        const bin = atob(base64);
                        const arr = new Uint8Array(bin.length);
                        for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
                        const blob = new Blob([arr], { type: 'image/png' });
                        saveAs(blob, `${fileName}.png`);
                    }
                } catch (e) { alert("æˆªå›¾å¤±è´¥ï¼š" + (e && e.message ? e.message : e)); }

                // â”€â”€ æ¢å¤åŠ¨ç”» â”€â”€
                this.chart.setOption({ animation: true }, { notMerge: false });
                btn.innerText = old; btn.disabled = false;
            },



            // â”€â”€ æ™ºèƒ½æ•°æ®æ’å€¼ï¼ˆæ¨¡æ‹Ÿ ECharts åŸç”ŸåŠ¨ç”»æ•ˆæœï¼‰ â”€â”€
            // line/area â†’ ä»å·¦åˆ°å³é€æ­¥æ˜¾ç°ï¼ˆsmooth æ’å€¼ï¼‰
            // bar/scatter/å…¶ä»– â†’ æ•°æ®ä» 0 é•¿åˆ°æœ€ç»ˆå€¼
            _interpolateForExport(option, t) {
                if (!option.series) return;
                option.series.forEach(series => {
                    if (!series.data || series.data.length === 0) return;
                    const type = series.type || 'line';
                    const total = series.data.length;
                    const getNum = (d) => {
                        if (typeof d === 'number') return d;
                        if (d && typeof d === 'object' && typeof d.value === 'number') return d.value;
                        if (Array.isArray(d)) { for (let i = d.length - 1; i >= 0; i--) if (typeof d[i] === 'number') return d[i]; }
                        return null;
                    };
                    const setNum = (d, v) => {
                        if (typeof d === 'number') return v;
                        if (d && typeof d === 'object' && typeof d.value === 'number') return Object.assign({}, d, { value: v });
                        if (Array.isArray(d)) { const c = d.slice(); for (let i = c.length - 1; i >= 0; i--) { if (typeof c[i] === 'number') { c[i] = v; break; } } return c; }
                        return d;
                    };

                    if (type === 'line') {
                        // ä»å·¦åˆ°å³é€æ­¥æ˜¾ç°ï¼Œæœ€åä¸€ä¸ªå¯è§ç‚¹åšå¹³æ»‘æ’å€¼
                        const progress = t * total;           // å¦‚ t=0.5, total=20 â†’ 10.0
                        const fullVisible = Math.floor(progress);
                        const frac = progress - fullVisible;   // å°æ•°éƒ¨åˆ†ï¼Œç”¨äºæ’å€¼

                        series.data = series.data.map((d, i) => {
                            if (i < fullVisible) return d;     // å®Œå…¨å¯è§
                            if (i === fullVisible) {
                                // å¹³æ»‘æ’å€¼ï¼šåœ¨å‰ä¸€ä¸ªå€¼å’Œå½“å‰å€¼ä¹‹é—´
                                const cur = getNum(d);
                                if (cur === null) return d;
                                if (i === 0) return setNum(d, cur * frac);
                                const prev = getNum(series.data[i - 1]);
                                if (prev === null) return setNum(d, cur * frac);
                                return setNum(d, prev + (cur - prev) * frac);
                            }
                            return null;                       // å°šæœªæ˜¾ç°
                        });
                    } else {
                        // bar/scatter/pie/å…¶ä»–ï¼šæ•°æ®ä» 0 ç¼©æ”¾åˆ°æœ€ç»ˆå€¼
                        series.data = series.data.map(d => {
                            const v = getNum(d);
                            if (v === null) return d;
                            return setNum(d, v * t);
                        });
                    }
                });
            },

            // â”€â”€ ç¼“åŠ¨å‡½æ•°è¡¨ â”€â”€
            _easingFn(name) {
                const fns = {
                    linear: t => t,
                    quadraticOut: t => t * (2 - t),
                    cubicOut: t => 1 - Math.pow(1 - t, 3),
                    cubicInOut: t => t < .5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2,
                    quarticOut: t => 1 - Math.pow(1 - t, 4),
                    quinticOut: t => 1 - Math.pow(1 - t, 5),
                    sinusoidalOut: t => Math.sin(t * Math.PI / 2),
                    exponentialOut: t => t === 1 ? 1 : 1 - Math.pow(2, -10 * t),
                    circularOut: t => Math.sqrt(1 - (t - 1) * (t - 1)),
                    bounceOut: t => {
                        if (t < 1 / 2.75) return 7.5625 * t * t;
                        if (t < 2 / 2.75) return 7.5625 * (t -= 1.5 / 2.75) * t + .75;
                        if (t < 2.5 / 2.75) return 7.5625 * (t -= 2.25 / 2.75) * t + .9375;
                        return 7.5625 * (t -= 2.625 / 2.75) * t + .984375;
                    },
                    backOut: t => { const s = 1.70158; return (t -= 1) * t * ((s + 1) * t + s) + 1; },
                };
                return fns[name] || fns.linear;
            },

            // â”€â”€ è§£æç”¨æˆ· option ä»£ç  â”€â”€
            _parseUserOption() {
                const code = document.getElementById('code-area').value;
                const fn = new Function('var option; ' + code + ' return option;');
                return fn();
            },

            // â”€â”€ å¯¹ option æ–½åŠ ä¸ runCode ç›¸åŒçš„æ ·å¼å¤„ç†ï¼ˆä¸å«åŠ¨ç”»ç›¸å…³ï¼‰ â”€â”€
            _applyOptionStyle(option) {
                if (!option.backgroundColor || option.backgroundColor === 'auto') option.backgroundColor = '#ffffff';
                this.deepScale(option);
                this.applyGlobalFontScale(option);
                if (!option.title) option.title = {};
                const showTitle = document.getElementById('title-show').checked;
                option.title.show = showTitle;
                if (showTitle) {
                    const titleText = document.getElementById('title-text').value;
                    if (titleText) option.title.text = titleText;
                    const titleSize = parseInt(document.getElementById('title-size').value);
                    if (!option.title.textStyle) option.title.textStyle = {};
                    option.title.textStyle.fontSize = titleSize;
                    option.title.top = document.getElementById('title-top').value + '%';
                    option.title.left = 'center';
                }
                if (!option.tooltip) option.tooltip = {};
                option.tooltip.show = false;
            },

            async startCinemaExport() {
                if (this.isExporting) return;
                this.isExporting = true;
                document.getElementById('render-modal').style.display = 'flex';
                document.getElementById('export-fill').style.width = '0%';
                document.getElementById('render-elapsed').textContent = '00:00';
                document.getElementById('render-eta').textContent = '--:--';

                const userSeconds = parseFloat(document.getElementById('anim-duration').value);
                const fps = parseInt(document.getElementById('export-fps').value) || 60;
                const totalFrames = Math.ceil(userSeconds * fps);
                const easingName = document.getElementById('anim-easing').value || 'cubicOut';
                const easeFn = this._easingFn(easingName);

                const zip = new JSZip();
                const fileName = this.getExportFileName();
                const folder = zip.folder(fileName);

                const exportStartTime = performance.now();
                const fmtTime = (ms) => {
                    const s = Math.round(ms / 1000);
                    return String(Math.floor(s / 60)).padStart(2, '0') + ':' + String(s % 60).padStart(2, '0');
                };
                this._exportTimerInterval = setInterval(() => {
                    if (!this.isExporting) return;
                    const elapsed = performance.now() - exportStartTime;
                    document.getElementById('render-elapsed').textContent = fmtTime(elapsed);
                    const pct = parseFloat(document.getElementById('export-fill').style.width) || 0;
                    if (pct > 0) {
                        document.getElementById('render-eta').textContent = fmtTime(Math.max(0, elapsed / (pct / 100) - elapsed));
                    }
                }, 1000);

                try {
                    // â”€â”€ Step 1: æ¸²æŸ“å®Œæ•´æ•°æ® â†’ è¯»å– Y è½´èŒƒå›´ â”€â”€
                    const fullOption = this._parseUserOption();
                    fullOption.animation = false;
                    this._applyOptionStyle(fullOption);
                    this.chart.setOption(fullOption, { notMerge: true });
                    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

                    const yAxisExtents = [];
                    try {
                        const model = this.chart.getModel();
                        for (let i = 0; ; i++) {
                            const comp = model.getComponent('yAxis', i);
                            if (!comp) break;
                            yAxisExtents.push({
                                min: comp.axis.scale.getExtent()[0],
                                max: comp.axis.scale.getExtent()[1]
                            });
                        }
                    } catch (e) { }

                    // åŒæ ·è¯»å– X è½´èŒƒå›´ï¼ˆæ•°å€¼è½´æ—¶éœ€è¦é”å®šï¼‰
                    const xAxisExtents = [];
                    try {
                        const model = this.chart.getModel();
                        for (let i = 0; ; i++) {
                            const comp = model.getComponent('xAxis', i);
                            if (!comp) break;
                            if (comp.axis.type === 'value' || comp.axis.type === 'time') {
                                xAxisExtents.push({
                                    min: comp.axis.scale.getExtent()[0],
                                    max: comp.axis.scale.getExtent()[1]
                                });
                            } else {
                                xAxisExtents.push(null); // category axis, no need to lock
                            }
                        }
                    } catch (e) { }

                    // â”€â”€ Step 2: é€å¸§é™æ€æ¸²æŸ“ï¼ˆæ•°æ®æ’å€¼ + å›ºå®šåæ ‡è½´ï¼‰ â”€â”€
                    for (let frame = 1; frame <= totalFrames; frame++) {
                        if (!this.isExporting) break;

                        const linearT = frame / totalFrames;
                        const t = easeFn(linearT);

                        const opt = this._parseUserOption();
                        opt.animation = false;
                        this._applyOptionStyle(opt);
                        this._interpolateForExport(opt, t);

                        // é”å®š Y è½´
                        if (yAxisExtents.length && opt.yAxis) {
                            const axes = Array.isArray(opt.yAxis) ? opt.yAxis : [opt.yAxis];
                            axes.forEach((ax, i) => {
                                if (yAxisExtents[i]) { ax.min = yAxisExtents[i].min; ax.max = yAxisExtents[i].max; }
                            });
                            opt.yAxis = axes;
                        }
                        // é”å®šæ•°å€¼ X è½´
                        if (xAxisExtents.length && opt.xAxis) {
                            const axes = Array.isArray(opt.xAxis) ? opt.xAxis : [opt.xAxis];
                            axes.forEach((ax, i) => {
                                if (xAxisExtents[i]) { ax.min = xAxisExtents[i].min; ax.max = xAxisExtents[i].max; }
                            });
                            opt.xAxis = axes;
                        }

                        this.chart.setOption(opt, { notMerge: true });
                        await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

                        const bg = opt.backgroundColor || '#ffffff';
                        const dataUrl = this.chart.getDataURL({
                            type: 'png', pixelRatio: 3, backgroundColor: bg, excludeComponents: ['toolbox']
                        });
                        folder.file(
                            `${fileName}_frame_${String(frame).padStart(4, '0')}.png`,
                            dataUrl.split(',')[1], { base64: true }
                        );

                        const pct = Math.round((frame / totalFrames) * 100);
                        document.getElementById('export-fill').style.width = pct + '%';
                        document.getElementById('render-info').innerText = `${frame}/${totalFrames}`;
                        document.getElementById('render-pct').innerText = pct + '%';
                    }
                } catch (e) {
                    console.error('å¯¼å‡ºå¤±è´¥', e);
                }

                clearInterval(this._exportTimerInterval);
                const totalElapsed = performance.now() - exportStartTime;
                document.getElementById('render-elapsed').textContent = fmtTime(totalElapsed);
                document.getElementById('render-eta').textContent = this.isExporting ? 'å®Œæˆ âœ…' : 'å·²å–æ¶ˆ';
                this.runCode(true, 1);

                if (this.isExporting) {
                    zip.generateAsync({ type: 'blob' }).then(blob => {
                        saveAs(blob, `${fileName}_${fps}fps.zip`);
                        setTimeout(() => {
                            document.getElementById('render-modal').style.display = 'none';
                            this.isExporting = false;
                        }, 1000);
                    });
                } else {
                    document.getElementById('render-modal').style.display = 'none';
                    this.isExporting = false;
                }
            },

            applyPreset() {
                const presetEl = document.getElementById('canvas-preset');
                if (!presetEl) return;
                const val = presetEl.value.split(',');
                const w = parseInt(val[0], 10);
                const h = parseInt(val[1], 10);
                if (!isNaN(w) && !isNaN(h)) {
                    this.state.width = w;
                    this.state.height = h;
                }
                const dom = document.getElementById('chart-container');
                if (dom) {
                    dom.style.width = this.state.width + 'px';
                    dom.style.height = this.state.height + 'px';
                }
                if (this.chart) this.chart.resize({ width: this.state.width, height: this.state.height });
                this.autoFit();
                this.runCode(true);
            },
            toggleFreeze() {
                this.isFrozen = !this.isFrozen;
                const badge = document.getElementById('freeze-badge');
                if (this.isFrozen) {
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                    this.chart.dispatchAction({ type: 'hideTip' });
                }
                this.runCode(false);
            },

            updateScale() {
                this.state.fontScale = parseFloat(document.getElementById('font-scale').value);
                this.state.tipScale = parseFloat(document.getElementById('tip-scale').value);
                this.runCode(false);
            },
            deepScale(obj) {
                if (!obj || typeof obj !== 'object') return;
                for (let key in obj) {
                    if (key === 'tooltip' || key === 'title' || key === 'xAxis' || key === 'yAxis' || key === 'legend') continue;
                    if (key === 'fontSize' && typeof obj[key] === 'number') obj[key] = Math.round(obj[key] * this.state.fontScale);
                    else if (typeof obj[key] === 'object') this.deepScale(obj[key]);
                }
            },
            applyGlobalFontScale(option) {
                const s = this.state.fontScale;
                const D = 14;
                const setAxis = (ax) => {
                    if (!ax) return;
                    if (!ax.axisLabel) ax.axisLabel = {};
                    const cur = ax.axisLabel.fontSize;
                    ax.axisLabel.fontSize = typeof cur === 'number' ? Math.round(cur * s) : Math.round(D * s);
                };
                [].concat(option.xAxis || []).forEach(setAxis);
                [].concat(option.yAxis || []).forEach(setAxis);
                if (option.legend) {
                    if (!option.legend.textStyle) option.legend.textStyle = {};
                    const cur = option.legend.textStyle.fontSize;
                    option.legend.textStyle.fontSize = typeof cur === 'number' ? Math.round(cur * s) : Math.round(D * s);
                }
                if (option.series && Array.isArray(option.series)) {
                    option.series.forEach(ser => {
                        if (ser.label && ser.label.fontSize != null) ser.label.fontSize = Math.round(Number(ser.label.fontSize) * s);
                    });
                }
            },
            stopExport() {
                this.isExporting = false;
                clearInterval(this._exportTimerInterval);
                document.getElementById('render-modal').style.display = 'none';
                this.runCode(true, 1);
            },
            resetCode() { document.getElementById('code-area').value = ''; }
        };

        window.onload = () => App.init();
    </script>
</body>

</html>