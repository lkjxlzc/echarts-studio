<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECharts æé€Ÿè¡¨æ ¼ä¸­è½¬å™¨</title>
    <meta name="description" content="ä½¿ç”¨ ECharts custom ç³»åˆ—æ¸²æŸ“é«˜å“è´¨æ•°æ®è¡¨æ ¼ï¼Œæ”¯æŒå®æ—¶é¢„è§ˆä¸é«˜æ¸…å¯¼å‡º">

    <!-- ECharts 5 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FileSaver for export -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <!-- JSZip for split export -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"SF Pro Display"', '"Segoe UI"', 'Roboto', 'sans-serif'],
                        mono: ['"SF Mono"', '"Cascadia Code"', '"Fira Code"', 'Consolas', 'monospace'],
                    },
                    colors: {
                        apple: {
                            bg: '#f5f5f7',
                            surface: '#ffffff',
                            border: 'rgba(0,0,0,0.06)',
                            text: '#1d1d1f',
                            secondary: '#86868b',
                            tertiary: '#aeaeb2',
                            blue: '#007aff',
                            green: '#34c759',
                            red: '#ff3b30',
                            orange: '#ff9500',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* â”€â”€ Glassmorphism & Premium Overrides â”€â”€ */
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
        }

        .preview-grid {
            background-image: radial-gradient(circle at 1px 1px, rgba(0, 0, 0, 0.06) 1px, transparent 0);
            background-size: 20px 20px;
        }

        /* â”€â”€ Custom scrollbar â”€â”€ */
        .slim-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .slim-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .slim-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 99px;
        }

        .slim-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.25);
        }

        /* â”€â”€ iOS Toggle Switch â”€â”€ */
        .ios-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 26px;
            flex-shrink: 0;
        }

        .ios-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }

        .ios-toggle .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: rgba(120, 120, 128, 0.2);
            border-radius: 26px;
            transition: background 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .ios-toggle .slider::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15), 0 1px 1px rgba(0, 0, 0, 0.06);
            transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .ios-toggle input:checked+.slider {
            background: #007aff;
        }

        .ios-toggle input:checked+.slider::before {
            transform: translateX(18px);
        }

        /* â”€â”€ Range slider Apple style â”€â”€ */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            border-radius: 99px;
            outline: none;
            background: linear-gradient(90deg, rgba(0, 122, 255, 0.15), rgba(120, 120, 128, 0.2));
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            border: none;
            cursor: pointer;
            box-shadow: 0 0.5px 1px rgba(0, 0, 0, 0.1), 0 1px 4px rgba(0, 0, 0, 0.12), 0 0 0 0.5px rgba(0, 0, 0, 0.04);
            transition: transform 0.18s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.12);
        }

        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(0.95);
        }

        /* â”€â”€ Button Spring â”€â”€ */
        .btn-spring {
            transition: all 0.22s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .btn-spring:hover {
            transform: translateY(-0.5px);
        }

        .btn-spring:active {
            transform: scale(0.97) translateY(0.5px);
            transition-duration: 0.08s;
        }

        /* â”€â”€ Zoom toolbar glass â”€â”€ */
        .zoom-bar {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: blur(24px) saturate(200%);
            -webkit-backdrop-filter: blur(24px) saturate(200%);
            border: 0.5px solid rgba(255, 255, 255, 0.5);
        }

        /* â”€â”€ Fade-in animation â”€â”€ */
        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-up {
            animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        /* â”€â”€ Color swatch ring â”€â”€ */
        input[type="color"] {
            -webkit-appearance: none;
            appearance: none;
            width: 36px;
            height: 36px;
            border: none;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.08), 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s;
        }

        input[type="color"]:hover {
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3), 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }

        /* â”€â”€ Font Dropdown (sync with table.html) â”€â”€ */
        .font-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            margin-top: 4px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            max-height: 220px;
            overflow-y: auto;
            z-index: 1000;
            padding: 4px;
            list-style: none;
            display: none;
            margin-bottom: 0;
            box-sizing: border-box;
        }

        .font-dropdown-list.show {
            display: block;
        }

        .font-dropdown-item {
            padding: 7px 10px;
            font-size: 12px;
            color: #1d1d1f;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.1s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin: 0;
        }

        .font-dropdown-item:hover,
        .font-dropdown-item.active {
            background: #007AFF;
            color: #fff;
        }

        #ai-status.success-toast {
            animation: status-success 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes status-success {
            0% {
                transform: translateY(10px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="h-screen flex bg-apple-bg text-apple-text font-sans overflow-hidden">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LEFT SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <aside id="sidebar"
        class="glass-panel w-[340px] min-w-[300px] flex flex-col border-r border-apple-border z-50 shadow-sm">

        <!-- Header -->
        <div class="flex-shrink-0 px-5 pt-5 pb-4 border-b border-apple-border bg-white/90 fade-up">
            <div class="flex items-center justify-between mb-1">
                <h1 class="text-xl font-bold tracking-tight">
                    æé€Ÿè¡¨æ ¼ <span class="text-apple-blue">ä¸­è½¬å™¨</span>
                </h1>
                <span
                    class="text-[10px] font-semibold text-apple-tertiary bg-black/[0.04] px-2.5 py-1 rounded-full tracking-wide">V1.0</span>
            </div>
            <p class="text-xs text-apple-secondary">ç²˜è´´æ•°æ® â†’ é…ç½®æ ·å¼ â†’ å®æ—¶æ¸²æŸ“ â†’ é«˜æ¸…å¯¼å‡º</p>
        </div>

        <!-- Scrollable Config Area -->
        <div class="flex-1 overflow-y-auto slim-scroll flex flex-col gap-2 p-3">

            <!-- â”€â”€ Data Input â”€â”€ -->
            <section class="bg-white rounded-xl border border-apple-border shadow-xs p-4 fade-up"
                style="animation-delay:0.05s">
                <h2 class="text-[11px] font-semibold text-apple-tertiary uppercase tracking-wider mb-2">æ•°æ®è¾“å…¥</h2>
                <textarea id="data-input" rows="8" spellcheck="false"
                    class="w-full rounded-lg border border-black/10 bg-black/[0.02] p-3 text-[13px] font-mono leading-relaxed resize-none
                           focus:outline-none focus:ring-2 focus:ring-apple-blue/30 focus:border-apple-blue transition-all"
                    placeholder="ç²˜è´´ CSV/TSV/ç©ºæ ¼åˆ†éš”æ•°æ®ï¼Œä¾‹å¦‚ï¼š&#10;å§“å,å¹´é¾„,åŸå¸‚,å¾—åˆ†&#10;å¼ ä¸‰,28,åŒ—äº¬,95&#10;æå››,32,ä¸Šæµ·,88&#10;ç‹äº”,25,å¹¿å·,92">å§“å,å¹´é¾„,åŸå¸‚,å¾—åˆ†
å¼ ä¸‰,28,åŒ—äº¬,95
æå››,32,ä¸Šæµ·,88
ç‹äº”,25,å¹¿å·,92
èµµå…­,36,æ·±åœ³,78
å­™ä¸ƒ,29,æ­å·,91
å‘¨å…«,41,æˆéƒ½,85</textarea>
                <div class="flex gap-2 mt-2">
                    <button onclick="App.render(true)"
                        class="btn-spring flex-1 bg-gradient-to-b from-[#0a84ff] to-apple-blue text-white text-[13px] font-semibold py-2.5 rounded-full shadow-md shadow-apple-blue/20">
                        â–¶ æ¸²æŸ“è¡¨æ ¼
                    </button>
                    <button onclick="App.clearData()"
                        class="btn-spring px-4 py-2.5 rounded-full text-[13px] font-medium bg-black/[0.04] border border-black/[0.06] text-apple-text hover:bg-black/[0.08]">
                        æ¸…ç©º
                    </button>
                </div>
                <p id="parse-status" class="text-[11px] text-apple-tertiary mt-2 min-h-[16px]"></p>
            </section>

            <!-- â”€â”€ DeepSeek AI Integration â”€â”€ -->
            <section class="bg-white rounded-xl border border-apple-border shadow-xs p-4 fade-up"
                style="animation-delay:0.1s">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-[11px] font-semibold text-apple-tertiary uppercase tracking-wider">ğŸ¤– AI æ™ºèƒ½è§£æ
                    </h2>
                    <span id="ai-api-status" class="text-[10px] font-semibold px-2 py-0.5 rounded-full"></span>
                </div>

                <!-- Provider & Model Selector -->
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-[12px] font-medium text-apple-secondary mb-1.5 block">æ¸ é“</label>
                        <select id="ai-provider" onchange="App.onProviderChange()"
                            class="w-full px-3 py-2 rounded-lg border border-black/10 bg-white text-[13px] cursor-pointer focus:outline-none focus:ring-2 focus:ring-apple-blue/20 transition-all appearance-none"
                            style="background-image:url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='none' viewBox='0 0 10 10'%3E%3Cpath d='M2 3.5L5 6.5L8 3.5' stroke='%23aeaeb2' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E&quot;);background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;">
                            <option value="deepseek" selected>DeepSeek</option>
                            <option value="openkey">OpenKey.red</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[12px] font-medium text-apple-secondary mb-1.5 block">æ¨¡å‹</label>
                        <select id="ai-model"
                            class="w-full px-3 py-2 rounded-lg border border-black/10 bg-white text-[13px] cursor-pointer focus:outline-none focus:ring-2 focus:ring-apple-blue/20 transition-all appearance-none"
                            style="background-image:url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='none' viewBox='0 0 10 10'%3E%3Cpath d='M2 3.5L5 6.5L8 3.5' stroke='%23aeaeb2' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E&quot;);background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;">
                            <option value="deepseek-chat" selected>deepseek-chat</option>
                            <option value="deepseek-reasoner">deepseek-reasoner</option>
                        </select>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex gap-2 mb-2">
                    <button id="ai-parse-btn" onclick="App.aiParse()"
                        class="btn-spring flex-1 bg-gradient-to-b from-purple-500 to-purple-600 text-white text-[12px] font-semibold py-2 rounded-full shadow-md shadow-purple-500/20">
                        âœ¨ AI è§£ææ•°æ®
                    </button>
                    <button onclick="App.testApi()"
                        class="btn-spring px-3 py-2 rounded-full text-[12px] font-medium bg-black/[0.04] border border-black/[0.06] text-apple-text hover:bg-black/[0.08]">
                        ğŸ”Œ æµ‹è¯•
                    </button>
                </div>
                <p id="ai-status" class="text-[10px] text-apple-tertiary mt-1 text-center min-h-[14px]"></p>

                <!-- Collapsible API Key Editor -->
                <details class="mt-2">
                    <summary
                        class="text-[10px] text-apple-tertiary cursor-pointer hover:text-apple-blue transition-colors">
                        âš™ï¸ ä¿®æ”¹ API Key</summary>
                    <input type="password" id="ai-apikey" placeholder="sk-xxxxxxxxxxxxxxxx"
                        class="w-full mt-2 px-3 py-2 rounded-lg border border-black/10 bg-black/[0.02] text-[12px] font-mono
                               focus:outline-none focus:ring-2 focus:ring-apple-blue/20 focus:border-apple-blue transition-all" onchange="App.saveApiKey()">
                </details>
            </section>

            <!-- â”€â”€ Style Config â”€â”€ -->
            <section class="bg-white rounded-xl border border-apple-border shadow-xs p-4 fade-up"
                style="animation-delay:0.15s">
                <h2 class="text-[11px] font-semibold text-apple-tertiary uppercase tracking-wider mb-3">æ ·å¼é…ç½®</h2>

                <!-- Primary Color -->
                <div class="flex items-center justify-between mb-4">
                    <label class="text-[13px] font-medium">ä¸»è‰²è°ƒ</label>
                    <input type="color" id="cfg-color" value="#007AFF" onchange="App.render(false)">
                </div>

                <!-- Font Family (searchable, like table.html) -->
                <div class="mb-4" style="position:relative; z-index:50;">
                    <label class="text-[12px] font-medium text-apple-secondary mb-1.5 block">å­—ä½“é¢æ¿</label>
                    <div style="display:flex; gap:6px; position:relative;">
                        <div style="flex:1; position:relative;">
                            <input type="text" id="font-family-input"
                                class="w-full px-3 py-2 rounded-lg border border-black/10 bg-white text-[13px] focus:outline-none focus:ring-2 focus:ring-apple-blue/20 transition-all"
                                placeholder="æœç´¢æˆ–è¾“å…¥å­—ä½“" value="sans-serif" autocomplete="off">
                            <ul id="font-dropdown-list" class="font-dropdown-list">
                                <li class="font-dropdown-item" data-val="sans-serif">ç³»ç»Ÿé»˜è®¤ (sans-serif)</li>
                            </ul>
                        </div>
                        <button id="font-load-btn"
                            class="btn-spring px-2.5 py-2 rounded-lg text-[13px] bg-black/[0.04] border border-black/[0.06] hover:bg-black/[0.08]"
                            title="åŠ è½½æœ¬åœ°ç³»ç»Ÿå­—ä½“">ğŸ”„</button>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <select id="font-style-select"
                            class="flex-1 px-2 py-1.5 rounded-lg border border-black/10 bg-white text-[12px] cursor-pointer focus:outline-none transition-all appearance-none"
                            style="background-image:url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='none' viewBox='0 0 10 10'%3E%3Cpath d='M2 3.5L5 6.5L8 3.5' stroke='%23aeaeb2' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E&quot;);background-repeat:no-repeat;background-position:right 8px center;padding-right:24px;">
                            <option value="Regular">Regular</option>
                        </select>
                        <div class="flex items-center gap-1.5">
                            <span id="font-scale-val"
                                class="text-[11px] font-semibold text-apple-blue tabular-nums min-w-[32px] text-right">100%</span>
                            <input type="range" id="font-scale" min="0.5" max="3.0" step="0.1" value="1.0"
                                title="æ–‡å­—ç¼©æ”¾æ¯”ä¾‹" class="w-20">
                        </div>
                    </div>
                </div>

                <!-- Column Width Ratio -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1.5">
                        <label class="text-[12px] font-medium text-apple-secondary">åˆ—å®½æ¯”ä¾‹</label>
                        <span id="cfg-colwidth-val"
                            class="text-[11px] font-semibold text-apple-blue tabular-nums">1.0</span>
                    </div>
                    <input type="range" id="cfg-colwidth" min="0.5" max="2.0" step="0.1" value="1.0"
                        oninput="document.getElementById('cfg-colwidth-val').textContent=this.value; App.render(false)"
                        class="w-full">
                </div>

                <!-- Row Height -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1.5">
                        <label class="text-[12px] font-medium text-apple-secondary">è¡Œé«˜</label>
                        <span id="cfg-rowheight-val"
                            class="text-[11px] font-semibold text-apple-blue tabular-nums">48</span>
                    </div>
                    <input type="range" id="cfg-rowheight" min="30" max="80" step="2" value="48"
                        oninput="document.getElementById('cfg-rowheight-val').textContent=this.value; App.render(false)"
                        class="w-full">
                </div>

                <!-- Header Font Size -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1.5">
                        <label class="text-[12px] font-medium text-apple-secondary">è¡¨å¤´å­—å·</label>
                        <span id="cfg-hfontsize-val"
                            class="text-[11px] font-semibold text-apple-blue tabular-nums">16</span>
                    </div>
                    <input type="range" id="cfg-hfontsize" min="10" max="30" step="1" value="16"
                        oninput="document.getElementById('cfg-hfontsize-val').textContent=this.value; App.render(false)"
                        class="w-full">
                </div>

                <!-- Body Font Size -->
                <div class="mb-2">
                    <div class="flex justify-between items-center mb-1.5">
                        <label class="text-[12px] font-medium text-apple-secondary">å†…å®¹å­—å·</label>
                        <span id="cfg-bfontsize-val"
                            class="text-[11px] font-semibold text-apple-blue tabular-nums">14</span>
                    </div>
                    <input type="range" id="cfg-bfontsize" min="10" max="26" step="1" value="14"
                        oninput="document.getElementById('cfg-bfontsize-val').textContent=this.value; App.render(false)"
                        class="w-full">
                </div>
            </section>

            <!-- â”€â”€ Background & Export â”€â”€ -->
            <section class="bg-white rounded-xl border border-apple-border shadow-xs p-4 fade-up"
                style="animation-delay:0.2s">
                <h2 class="text-[11px] font-semibold text-apple-tertiary uppercase tracking-wider mb-3">èƒŒæ™¯ä¸å¯¼å‡º</h2>

                <!-- Background Toggle -->
                <div class="flex items-center justify-between mb-4">
                    <label class="text-[13px] font-medium">é€æ˜èƒŒæ™¯</label>
                    <label class="ios-toggle">
                        <input type="checkbox" id="cfg-transparent" onchange="App.render(false)">
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Canvas Size -->
                <div class="mb-4">
                    <label class="text-[12px] font-medium text-apple-secondary mb-1.5 block">ç”»å¸ƒå°ºå¯¸</label>
                    <select id="cfg-canvas" onchange="App.applyCanvasSize()"
                        class="w-full px-3 py-2 rounded-lg border border-black/10 bg-white text-[13px] cursor-pointer focus:outline-none focus:ring-2 focus:ring-apple-blue/20 transition-all appearance-none"
                        style="background-image:url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='none' viewBox='0 0 10 10'%3E%3Cpath d='M2 3.5L5 6.5L8 3.5' stroke='%23aeaeb2' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E&quot;);background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;">
                        <option value="auto" selected>ï¿½ è‡ªåŠ¨é€‚é…æ•°æ®</option>
                        <option value="1080,1890">ï¿½ğŸ“± 8:14 ç«–å±</option>
                        <option value="1080,1920">ğŸµ 9:16 ç«–å±</option>
                        <option value="1920,1080">ğŸ“º 16:9 æ¨ªå±</option>
                        <option value="1080,1080">â¬œ 1:1 æ­£æ–¹å½¢</option>
                        <option value="800,600">ğŸ–¥ 4:3 ç»å…¸</option>
                    </select>
                </div>

                <!-- Export Quality -->
                <div class="mb-4">
                    <label class="text-[12px] font-medium text-apple-secondary mb-1.5 block">å¯¼å‡ºè´¨é‡</label>
                    <select id="cfg-quality"
                        class="w-full px-3 py-2 rounded-lg border border-black/10 bg-white text-[13px] cursor-pointer focus:outline-none focus:ring-2 focus:ring-apple-blue/20 transition-all appearance-none"
                        style="background-image:url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='none' viewBox='0 0 10 10'%3E%3Cpath d='M2 3.5L5 6.5L8 3.5' stroke='%23aeaeb2' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E&quot;);background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;">
                        <option value="2">4K é«˜æ¸…</option>
                        <option value="8">8K è¶…æ¸…</option>
                    </select>
                </div>

                <!-- Export Filename -->
                <div class="mb-4">
                    <label class="text-[12px] font-medium text-apple-secondary mb-1.5 block">å¯¼å‡ºæ–‡ä»¶å</label>
                    <input type="text" id="cfg-filename" value="ECharts_Table"
                        class="w-full px-3 py-2 rounded-lg border border-black/10 bg-black/[0.02] text-[13px] font-semibold text-center
                               focus:outline-none focus:ring-2 focus:ring-apple-blue/20 focus:border-apple-blue transition-all">
                </div>

                <!-- Export Buttons -->
                <button onclick="App.exportHD()"
                    class="btn-spring w-full bg-gradient-to-b from-[#30d158] to-apple-green text-white text-[13px] font-semibold py-2.5 rounded-full shadow-md shadow-apple-green/20 mb-2">
                    ğŸ“¸ æˆªå›¾å¯¼å‡º
                </button>
                <button onclick="App.exportTransparent()"
                    class="btn-spring w-full px-4 py-2.5 rounded-full text-[13px] font-medium bg-black/[0.04] border border-black/[0.06] text-apple-text hover:bg-black/[0.08] mb-2">
                    ğŸ”² å¯¼å‡ºé€æ˜èƒŒæ™¯
                </button>
                <button id="export-zip-btn" onclick="App.exportSplitZip()"
                    class="btn-spring w-full px-4 py-2.5 rounded-full text-[13px] font-medium bg-gradient-to-b from-orange-400 to-orange-500 text-white shadow-md shadow-orange-400/20">
                    ğŸ“¦ å¯¼å‡ºã€Œä»…èƒŒæ™¯ã€+ã€Œä»…æ–‡å­—ã€ZIP
                </button>
                <p id="export-status" class="text-[10px] text-apple-tertiary mt-2 text-center min-h-[14px]"></p>
            </section>

            <!-- â”€â”€ Quick Links â”€â”€ -->
            <div class="text-center py-2 fade-up" style="animation-delay:0.25s">
                <a href="Echart.html"
                    class="text-[12px] text-apple-blue font-medium hover:opacity-70 transition-opacity">â† è¿”å› ECharts
                    Studio</a>
                <span class="text-apple-tertiary mx-2">|</span>
                <a href="table.html"
                    class="text-[12px] text-apple-blue font-medium hover:opacity-70 transition-opacity">è¡¨æ ¼å¯¼å‡ºå·¥å…· â†’</a>
            </div>
        </div>
    </aside>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RIGHT PREVIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <main id="preview-stage"
        class="flex-1 relative flex justify-center items-center overflow-hidden preview-grid bg-[#ececf0]"
        style="background: radial-gradient(ellipse at 30% 20%, rgba(0,122,255,0.03) 0%, transparent 60%), radial-gradient(ellipse at 70% 80%, rgba(175,82,222,0.03) 0%, transparent 60%), #ececf0;">

        <!-- Chart Container -->
        <div id="chart-container" class="bg-white rounded-2xl shadow-xl"
            style="width:1080px; height:1890px; transform-origin:center center;"></div>

        <!-- Zoom Toolbar -->
        <div
            class="zoom-bar absolute bottom-5 left-1/2 -translate-x-1/2 rounded-full px-3 py-1.5 flex items-center gap-1 shadow-lg z-50">
            <button onclick="App.zoom(-0.05)"
                class="btn-spring w-8 h-8 flex items-center justify-center rounded-lg text-base font-medium hover:bg-black/[0.06]">âˆ’</button>
            <span id="zoom-level"
                class="text-[12px] font-semibold text-apple-secondary tabular-nums min-w-[40px] text-center">45%</span>
            <button onclick="App.zoom(0.05)"
                class="btn-spring w-8 h-8 flex items-center justify-center rounded-lg text-base font-medium hover:bg-black/[0.06]">+</button>
            <div class="w-px h-4 bg-black/10 mx-1"></div>
            <button onclick="App.autoFit()"
                class="btn-spring px-2.5 h-8 flex items-center justify-center rounded-lg text-[12px] font-semibold hover:bg-black/[0.06]">Fit</button>
            <button onclick="App.resetZoom()"
                class="btn-spring px-2.5 h-8 flex items-center justify-center rounded-lg text-[12px] font-semibold hover:bg-black/[0.06]">1:1</button>
        </div>
    </main>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT ENGINE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        window.App = {
            chart: null,
            fontFamily: 'sans-serif',
            fontScale: 1.0,
            availableFonts: [],
            state: { width: 1080, height: 1890, viewScale: 0.45, viewX: 0, viewY: 0 },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  INIT
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            init() {
                const dom = document.getElementById('chart-container');
                this.chart = echarts.init(dom, null, { renderer: 'canvas', devicePixelRatio: 2 });
                this.initCanvasControl();
                this.applyCanvasSize();

                // Initialize API provider and keys
                this.onProviderChange();

                // Init font panel (searchable dropdown like table.html)
                this.initFontPanel();

                // Ctrl+Enter shortcut
                window.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') this.render(true);
                });

                // Initial render
                this.render(true);
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  DATA PARSING â€” auto-detect CSV / TSV / space
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            parseInputData(raw) {
                if (!raw || !raw.trim()) return null;
                const lines = raw.trim().split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 2) return null; // need at least header + 1 row

                // Detect delimiter: tab > comma > multiple-spaces
                const firstLine = lines[0];
                let delimiter;
                if (firstLine.includes('\t')) delimiter = '\t';
                else if (firstLine.includes(',')) delimiter = ',';
                else if (firstLine.includes('|')) delimiter = '|';
                else delimiter = /\s{2,}/; // multiple spaces

                const splitLine = (line) => {
                    if (delimiter instanceof RegExp) return line.split(delimiter).map(s => s.trim());
                    return line.split(delimiter).map(s => s.trim());
                };

                const headers = splitLine(lines[0]);
                const rows = [];
                for (let i = 1; i < lines.length; i++) {
                    const cells = splitLine(lines[i]);
                    // Pad or trim to match header count
                    while (cells.length < headers.length) cells.push('');
                    rows.push(cells.slice(0, headers.length));
                }

                return { headers, rows };
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  API KEY â€” save / test
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            saveApiKey() {
                const key = document.getElementById('ai-apikey').value.trim();
                if (key) sessionStorage.setItem('deepseek_api_key', key);
                this.testApi();
            },

            async testApi() {
                const apiKey = (document.getElementById('ai-apikey')?.value || '').trim();
                const statusBadge = document.getElementById('ai-api-status');
                const statusEl = document.getElementById('ai-status');

                if (!apiKey) {
                    if (statusBadge) { statusBadge.textContent = 'âŒ æ—  Key'; statusBadge.style.cssText = 'color:#ff3b30;background:rgba(255,59,48,0.08);'; }
                    return;
                }
                if (statusBadge) { statusBadge.textContent = 'â³ æµ‹è¯•ä¸­'; statusBadge.style.cssText = 'color:#86868b;background:rgba(0,0,0,0.04);'; }
                if (statusEl) { statusEl.textContent = 'æ­£åœ¨éªŒè¯ API Key...'; statusEl.style.color = '#86868b'; }

                try {
                    const res = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                        body: JSON.stringify({ model: 'deepseek-chat', messages: [{ role: 'user', content: 'hi' }], max_tokens: 1 })
                    });
                    const data = await res.json();
                    if (data.error) {
                        if (statusBadge) { statusBadge.textContent = 'âŒ ä¸å¯ç”¨'; statusBadge.style.cssText = 'color:#ff3b30;background:rgba(255,59,48,0.08);'; }
                        if (statusEl) { statusEl.textContent = 'âŒ ' + (data.error.message || 'API é”™è¯¯'); statusEl.style.color = '#ff3b30'; }
                    } else {
                        if (statusBadge) { statusBadge.textContent = 'âœ… å¯ç”¨'; statusBadge.style.cssText = 'color:#34c759;background:rgba(52,199,89,0.08);'; }
                        if (statusEl) { statusEl.textContent = 'âœ… API è¿æ¥æ­£å¸¸'; statusEl.style.color = '#34c759'; }
                    }
                } catch (e) {
                    if (statusBadge) { statusBadge.textContent = 'âŒ ä¸å¯ç”¨'; statusBadge.style.cssText = 'color:#ff3b30;background:rgba(255,59,48,0.08);'; }
                    if (statusEl) { statusEl.textContent = 'âŒ ç½‘ç»œé”™è¯¯: ' + (e.message || e); statusEl.style.color = '#ff3b30'; }
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  FONT PANEL â€” searchable dropdown (like table.html)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async loadSystemFonts() {
                if (!window.queryLocalFonts) {
                    alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯»å–ç³»ç»Ÿå­—ä½“åˆ—è¡¨ (éœ€ Chrome 103+ / Edge)ã€‚\nä½ å¯ä»¥ç›´æ¥åœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥å­—ä½“å (ä¾‹å¦‚ "Microsoft YaHei") æ¥å¼ºåˆ¶åº”ç”¨ã€‚');
                    return;
                }
                try {
                    const fonts = await window.queryLocalFonts();
                    const familyMap = new Map();
                    fonts.forEach(f => {
                        let existing = familyMap.get(f.family);
                        if (!existing) { existing = { fullName: f.fullName, styles: [] }; familyMap.set(f.family, existing); }
                        existing.styles.push({ style: f.style || 'Regular', fullName: f.fullName, postscriptName: f.postscriptName });
                        if (/[\u4e00-\u9fa5]/.test(f.fullName) && !/[\u4e00-\u9fa5]/.test(existing.fullName)) existing.fullName = f.fullName;
                    });
                    familyMap.forEach(v => {
                        const uniq = []; const seen = new Set();
                        v.styles.forEach(s => { if (!seen.has(s.style)) { seen.add(s.style); uniq.push(s); } });
                        uniq.sort((a, b) => {
                            const w = s => { s = s.toLowerCase(); if (s.includes('thin')) return 100; if (s.includes('light')) return 300; if (s.includes('regular') || s.includes('normal')) return 400; if (s.includes('medium')) return 500; if (s.includes('semibold')) return 600; if (s.includes('bold')) return 700; if (s.includes('black') || s.includes('heavy')) return 900; return 400; };
                            return w(a.style) - w(b.style);
                        });
                        v.styles = uniq;
                    });
                    this.availableFonts = Array.from(familyMap, ([family, v]) => ({ family, displayName: v.fullName, styles: v.styles }));
                    this.availableFonts.sort((a, b) => a.displayName.localeCompare(b.displayName, 'zh-Hans'));
                } catch (e) { alert('åŠ è½½å­—ä½“å¤±è´¥: ' + e.message); }
            },

            initFontPanel() {
                const fontInput = document.getElementById('font-family-input');
                const fontList = document.getElementById('font-dropdown-list');
                const fontLoadBtn = document.getElementById('font-load-btn');
                const fontStyleSelect = document.getElementById('font-style-select');
                const fontScaleNode = document.getElementById('font-scale');
                const fontScaleVal = document.getElementById('font-scale-val');

                // Scale slider
                if (fontScaleNode) {
                    fontScaleNode.addEventListener('input', (e) => {
                        this.fontScale = parseFloat(e.target.value) || 1.0;
                        if (fontScaleVal) fontScaleVal.textContent = Math.round(this.fontScale * 100) + '%';
                        this.render(false);
                    });
                }

                // Populate font styles for a selected family
                this.populateFontStyles = (familyName) => {
                    if (!fontStyleSelect) return;
                    fontStyleSelect.innerHTML = '';
                    const fontObj = this.availableFonts.find(f => f.family === familyName);
                    if (!fontObj || !fontObj.styles || fontObj.styles.length === 0) {
                        fontStyleSelect.innerHTML = '<option value="Regular">Regular</option>';
                        fontStyleSelect.disabled = true;
                    } else {
                        fontStyleSelect.disabled = false;
                        fontObj.styles.forEach(s => { const opt = document.createElement('option'); opt.value = s.postscriptName; opt.textContent = s.style; fontStyleSelect.appendChild(opt); });
                    }
                };

                if (fontStyleSelect) fontStyleSelect.addEventListener('change', () => this.render(false));

                // Render font list items
                this.renderFonts = (filterKey = '') => {
                    if (!fontList) return;
                    let html = '<li class="font-dropdown-item" data-val="sans-serif" style="font-family:sans-serif;">ç³»ç»Ÿé»˜è®¤ (sans-serif)</li>';
                    const key = filterKey.toLowerCase().trim();
                    const filtered = key ? this.availableFonts.filter(f => f.family.toLowerCase().includes(key) || f.displayName.toLowerCase().includes(key)) : this.availableFonts;
                    filtered.forEach(f => { html += `<li class="font-dropdown-item" data-val="${f.family}" style="font-family:'${f.family}',sans-serif;" title="${f.family}">${f.displayName}</li>`; });
                    if (filtered.length === 0 && key) html += '<li class="font-dropdown-item" style="color:#86868b;pointer-events:none;">æ— åŒ¹é…å­—ä½“, æŒ‰å›è½¦å¼ºåˆ¶åº”ç”¨</li>';
                    fontList.innerHTML = html;
                };

                let hideTimeout; let previewOriginal = null;

                if (fontInput) {
                    fontInput.addEventListener('focus', () => { this.renderFonts(''); fontList && fontList.classList.add('show'); fontInput.select(); });
                    fontInput.addEventListener('click', () => fontInput.select());
                    fontInput.addEventListener('blur', () => {
                        hideTimeout = setTimeout(() => {
                            fontList && fontList.classList.remove('show');
                            if (previewOriginal !== null) { this.fontFamily = previewOriginal; previewOriginal = null; }
                            if (fontInput) { this.fontFamily = fontInput.value.trim() || 'sans-serif'; if (this.populateFontStyles) this.populateFontStyles(this.fontFamily); }
                            this.render(false);
                        }, 200);
                    });
                    fontInput.addEventListener('input', (e) => { this.renderFonts(e.target.value); fontList && fontList.classList.add('show'); });
                    fontInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { fontList && fontList.classList.remove('show'); fontInput.blur(); } });
                }

                if (fontList) {
                    fontList.addEventListener('mouseover', (e) => {
                        const item = e.target.closest('.font-dropdown-item');
                        if (item && item.dataset.val) { if (previewOriginal === null) previewOriginal = this.fontFamily; this.fontFamily = item.dataset.val; this.render(false); }
                    });
                    fontList.addEventListener('mouseleave', () => {
                        if (previewOriginal !== null) { this.fontFamily = previewOriginal; previewOriginal = null; this.render(false); }
                    });
                    fontList.addEventListener('mousedown', (e) => {
                        const item = e.target.closest('.font-dropdown-item');
                        if (item && item.dataset.val) {
                            if (fontInput) fontInput.value = item.dataset.val;
                            previewOriginal = null;
                            if (this.populateFontStyles) this.populateFontStyles(item.dataset.val);
                            this.fontFamily = item.dataset.val;
                            if (hideTimeout) clearTimeout(hideTimeout);
                            fontList.classList.remove('show');
                            this.render(false);
                        }
                    });
                }

                if (fontLoadBtn) {
                    fontLoadBtn.addEventListener('click', () => {
                        this.loadSystemFonts().then(() => {
                            if (fontInput) {
                                this.renderFonts(fontInput.value === 'sans-serif' ? '' : fontInput.value);
                                fontInput.focus();
                                fontList && fontList.classList.add('show');
                            }
                        });
                    });
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  Hardened Precision Scraper â€” ç²¾å¯†é‡‘èæ•°æ®è½¬æ¢å™¨
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async aiParse() {
                const provider = document.getElementById('ai-provider').value;
                const apiKey = (document.getElementById('ai-apikey')?.value || '').trim();
                const model = document.getElementById('ai-model').value;
                let rawText = document.getElementById('data-input').value.trim();
                const statusEl = document.getElementById('ai-status');
                const btn = document.getElementById('ai-parse-btn');

                const endpoint = provider === 'deepseek'
                    ? 'https://api.deepseek.com/chat/completions'
                    : 'https://api.openkey.red/v1/chat/completions';

                if (!apiKey) { statusEl.textContent = 'âŒ è¯·å¡«å†™ API Key'; statusEl.style.color = '#ff3b30'; return; }
                if (!rawText) { statusEl.textContent = 'âŒ è¯·å…ˆç²˜è´´æ•°æ®'; statusEl.style.color = '#ff3b30'; return; }

                sessionStorage.setItem(`api_key_${provider}`, apiKey);

                btn.disabled = true;
                const oldText = btn.textContent;
                btn.textContent = 'â³ AI æ­£åœ¨åˆ†æ...';
                statusEl.textContent = 'æ­£åœ¨å‘èµ·ç²¾å¯†åˆ†æ (' + model + ')...';
                statusEl.style.color = '#86868b';

                // Pre-processing
                rawText = rawText.replace(/\n\s*\n/g, '\n').trim();

                const systemPrompt = `ä½ ç°åœ¨æ˜¯ã€ç²¾å¯†é‡‘èæ•°æ®è½¬æ¢å™¨ã€‘ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯å°†ä¹±åºçš„ä¿é™©åˆ©ç›Šæ¼”ç¤ºè¡¨æ–‡æœ¬è½¬æ¢ä¸ºç»“æ„åŒ– JSONã€‚

æ ¸å¿ƒè§„åˆ™ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰ï¼š
1. **ä¸¥ç¦æ‹†åˆ†é€—å·**ï¼šæ•°å­—ä¸­çš„é€—å·ï¼ˆå¦‚ 500,000ï¼‰å¿…é¡»ä½œä¸ºæ•°å€¼çš„ä¸€éƒ¨åˆ†å®Œæ•´ä¿ç•™ï¼Œç»å¯¹ç¦æ­¢å°†å…¶è§†ä¸ºåˆ—åˆ†éš”ç¬¦ã€‚
2. **æ­»å®ˆ 5 åˆ—ç»“æ„**ï¼šè¾“å‡ºçš„æ¯ä¸€è¡Œå¿…é¡»ä¸¥æ ¼å¯¹åº”ã€ä¿å•å¹´åº¦ã€ç´¯è®¡ç¼´è´¹ã€æå–é‡‘é¢ã€ç´¯è®¡æå–ã€è´¦æˆ·ä½™é¢ã€‘ã€‚
3. **å­—ç¬¦ä¸²è¿”å›**ï¼šä¸ºäº†ç»å¯¹ä¿ç•™åƒåˆ†ä½é€—å·ï¼Œè¯·å°†æ‰€æœ‰æ•°å€¼ä»¥â€œå­—ç¬¦ä¸²â€å½¢å¼è¿”å›ï¼ˆä¾‹å¦‚ "1,000,000" è€Œä¸æ˜¯ 1000000ï¼‰ã€‚
4. **ç©ºå€¼è¡¥é½**ï¼šå¦‚æœæŸåˆ—æ•°æ®ç¼ºå¤±ï¼Œå¿…é¡»ä½¿ç”¨ "-" å ä½ï¼Œç¡®ä¿ DATA æ•°ç»„ä¸­æ¯ä¸€è¡Œéƒ½æœ‰ä¸”åªæœ‰ 5 ä¸ªå…ƒç´ ã€‚
5. **ä»»åŠ¡æµç¨‹**ï¼šè¯†åˆ«â€˜ä¿å•å¹´åº¦â€™ä½œä¸ºè¡Œèµ·å§‹é”šç‚¹ï¼Œæ•´ç†åç»­ 4 ä¸ªå¯¹åº”çš„è´¢åŠ¡è¦ç´ ã€‚

è¿”å›æ ¼å¼è¦æ±‚ï¼ˆçº¯ JSONï¼‰ï¼š
{
  "labels": { "sideTitle": "ä¿å•å¹´åº¦", "subTitles": ["ç´¯è®¡ç¼´è´¹", "æå–é‡‘é¢", "ç´¯è®¡æå–", "è´¦æˆ·ä½™é¢"] },
  "data": [ ["1", "500,000", "-", "-", "0"], ["2", "1,000,000", "-", "-", "65,340"] ]
}`;

                try {
                    const res = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: rawText }
                            ],
                            max_tokens: 4096,
                            temperature: 0.1
                        })
                    });

                    const responseData = await res.json();
                    if (responseData.error) {
                        statusEl.textContent = 'âŒ API é”™è¯¯: ' + (responseData.error.message || JSON.stringify(responseData.error));
                        statusEl.style.color = '#ff3b30';
                        return;
                    }

                    let rawContent = (responseData.choices?.[0]?.message?.content || '').trim();
                    if (!rawContent) { statusEl.textContent = 'âŒ AI æœªè¿”å›å†…å®¹'; statusEl.style.color = '#ff3b30'; return; }

                    // Robust JSON extraction
                    const jsonMatch = rawContent.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error('æ— æ³•æå– JSON ç»“æ„');
                    const parsed = JSON.parse(jsonMatch[0]);

                    if (!parsed.labels || !parsed.data) throw new Error('JSON å­—æ®µç¼ºå¤±');

                    const headers = [parsed.labels.sideTitle, ...parsed.labels.subTitles];
                    const rows = parsed.data.map(row => {
                        // Strict padding to 5 columns
                        const r = [...row];
                        while (r.length < 5) r.push('-');
                        return r.slice(0, 5);
                    });

                    // Build CSV output with protective quotes for commas
                    const escape = val => {
                        let s = String(val);
                        if (/[,\n"]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
                        return s;
                    };
                    const csvLines = [headers.map(escape).join(',')];
                    rows.forEach(row => csvLines.push(row.map(escape).join(',')));

                    document.getElementById('data-input').value = csvLines.join('\n');

                    // Immediate Update
                    this.render(true);

                    statusEl.textContent = `âœ… ç²¾å¯†è§£ææˆåŠŸ (${rows.length} è¡Œ)`;
                    statusEl.style.color = '#34c759';
                    statusEl.classList.remove('success-toast');
                    void statusEl.offsetWidth;
                    statusEl.classList.add('success-toast');

                } catch (e) {
                    console.error('AI Parse Error:', e);
                    statusEl.textContent = 'âŒ è§£æå¤±è´¥: ' + (e.message || e);
                    statusEl.style.color = '#ff3b30';
                } finally {
                    btn.disabled = false;
                    btn.textContent = oldText;
                }
            },

            async parseData(rawText) {
                // æœ¬åœ°è§£æ fallback
                return this.parseInputData(rawText);
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  GET CONFIG from UI
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            getConfig() {
                return {
                    primaryColor: document.getElementById('cfg-color').value,
                    fontFamily: this.fontFamily || 'sans-serif',
                    fontScale: this.fontScale || 1.0,
                    colWidthRatio: parseFloat(document.getElementById('cfg-colwidth').value),
                    rowHeight: parseInt(document.getElementById('cfg-rowheight').value),
                    headerFontSize: parseInt(document.getElementById('cfg-hfontsize').value),
                    bodyFontSize: parseInt(document.getElementById('cfg-bfontsize').value),
                    transparent: document.getElementById('cfg-transparent').checked,
                };
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  BUILD ECHARTS OPTION â€” custom series table
            //  â˜… Core: uses type:'custom' + renderItem
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // renderMode: 'normal' | 'textOnly' | 'bgOnly'
            buildTableOption(data, config, renderMode = 'normal') {
                if (!data || !data.headers || !data.rows) return null;

                const { headers, rows } = data;
                const COLS = headers.length;
                const ROWS = rows.length;
                const TOTAL_ROWS = ROWS + 1; // +1 for header

                const ROW_H = config.rowHeight;
                const TABLE_H = TOTAL_ROWS * ROW_H;
                const COL_W = Math.floor((this.state.width * 0.88) / COLS) * config.colWidthRatio;
                const TABLE_W = COL_W * COLS;
                const OFFSET_X = (this.state.width - TABLE_W) / 2;
                const OFFSET_Y = Math.max(60, (this.state.height - TABLE_H) / 2 - 40);

                // Lighter/darker from primary for alternating rows
                const hexToRgb = (hex) => {
                    const r = parseInt(hex.slice(1, 3), 16);
                    const g = parseInt(hex.slice(3, 5), 16);
                    const b = parseInt(hex.slice(5, 7), 16);
                    return [r, g, b];
                };
                const [pr, pg, pb] = hexToRgb(config.primaryColor);
                const headerBg = config.primaryColor;
                const headerTextColor = '#FFFFFF';
                const rowEvenBg = '#FFFFFF';
                const rowOddBg = `rgba(${pr}, ${pg}, ${pb}, 0.04)`;
                const borderColor = `rgba(${pr}, ${pg}, ${pb}, 0.12)`;
                const cellTextColor = '#1d1d1f';

                // Build flat data: [rowIndex, colIndex, cellValue, isHeader]
                const seriesData = [];
                // Header row (index 0)
                for (let c = 0; c < COLS; c++) {
                    seriesData.push([0, c, headers[c], 1]);
                }
                // Data rows (index 1..ROWS)
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        seriesData.push([r + 1, c, rows[r][c], 0]);
                    }
                }

                // â˜… Custom series renderItem â€” THE CORE RENDERING ENGINE
                // This draws each table cell as a group of rect + text
                const renderItem = (params, api) => {
                    const rowIdx = api.value(0);
                    const colIdx = api.value(1);
                    const cellText = api.value(2);
                    const isHeader = api.value(3);

                    const x = OFFSET_X + colIdx * COL_W;
                    const y = OFFSET_Y + rowIdx * ROW_H;

                    // Determine cell background
                    let bgColor;
                    if (isHeader) {
                        bgColor = headerBg;
                    } else {
                        bgColor = (rowIdx % 2 === 0) ? rowOddBg : rowEvenBg;
                    }

                    // Build group of children
                    const children = [];

                    // â‘  Cell background rect (skip in textOnly mode)
                    if (renderMode !== 'textOnly') {
                        children.push({
                            type: 'rect',
                            shape: { x: x, y: y, width: COL_W, height: ROW_H },
                            style: {
                                fill: bgColor,
                                stroke: borderColor,
                                lineWidth: 0.5,
                            },
                            ...(isHeader && colIdx === 0 ? { shape: { x, y, width: COL_W, height: ROW_H, r: [8, 0, 0, 0] } } : {}),
                            ...(isHeader && colIdx === COLS - 1 ? { shape: { x, y, width: COL_W, height: ROW_H, r: [0, 8, 0, 0] } } : {}),
                            ...(!isHeader && rowIdx === ROWS && colIdx === 0 ? { shape: { x, y, width: COL_W, height: ROW_H, r: [0, 0, 0, 8] } } : {}),
                            ...(!isHeader && rowIdx === ROWS && colIdx === COLS - 1 ? { shape: { x, y, width: COL_W, height: ROW_H, r: [0, 0, 8, 0] } } : {}),
                        });
                    }

                    // â‘¡ Cell text (skip in bgOnly mode)
                    if (renderMode !== 'bgOnly') {
                        children.push({
                            type: 'text',
                            style: {
                                x: x + COL_W / 2,
                                y: y + ROW_H / 2,
                                text: String(cellText),
                                fill: isHeader ? headerTextColor : cellTextColor,
                                font: `${isHeader ? 'bold' : 'normal'} ${Math.round((isHeader ? config.headerFontSize : config.bodyFontSize) * (config.fontScale || 1))}px ${config.fontFamily}`,
                                textAlign: 'center',
                                textVerticalAlign: 'middle',
                                truncate: { outerWidth: COL_W - 12, ellipsis: 'â€¦' },
                            },
                        });
                    }

                    return {
                        type: 'group',
                        children: children,
                    };
                };

                // â˜… ECharts option using custom series
                // Background logic per render mode
                let optBg;
                if (renderMode === 'textOnly') optBg = 'transparent';
                else if (renderMode === 'bgOnly') optBg = config.transparent ? 'transparent' : '#FFFFFF';
                else optBg = config.transparent ? 'transparent' : '#FFFFFF';

                const option = {
                    backgroundColor: optBg,
                    animation: true,
                    animationDuration: 600,
                    animationEasing: 'cubicOut',
                    // No axis / grid â€” pure custom rendering
                    xAxis: { show: false, min: 0, max: this.state.width },
                    yAxis: { show: false, min: 0, max: this.state.height, inverse: true },
                    grid: { left: 0, right: 0, top: 0, bottom: 0, containLabel: false },
                    tooltip: { show: false },
                    series: [{
                        type: 'custom',
                        renderItem: renderItem,
                        data: seriesData,
                        // Each data point has 4 dimensions: [rowIdx, colIdx, text, isHeader]
                        encode: { x: 1, y: 0 },
                        coordinateSystem: 'cartesian2d',
                        z: 10,
                    }],
                    // Title removed per user request
                    title: { show: false },
                };

                return option;
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  RENDER â€” main reactive binding
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            render(isFullReset = false) {
                const statusEl = document.getElementById('parse-status');
                const raw = document.getElementById('data-input').value;
                const data = this.parseInputData(raw);

                if (!data) {
                    if (statusEl) { statusEl.textContent = 'âš ï¸ æ— æ³•è§£ææ•°æ®ï¼Œè¯·æ£€æŸ¥æ ¼å¼'; statusEl.style.color = '#ff3b30'; }
                    return;
                }

                if (statusEl) {
                    statusEl.textContent = `âœ… å·²è§£æ ${data.headers.length} åˆ— Ã— ${data.rows.length} è¡Œ`;
                    statusEl.style.color = '#34c759';
                }

                // Auto-fit canvas if 'auto' is selected
                const canvasMode = document.getElementById('cfg-canvas').value;
                if (canvasMode === 'auto') this.autoFitToData(data);

                const config = this.getConfig();
                const option = this.buildTableOption(data, config);

                if (!option) return;

                // Update chart container background
                const container = document.getElementById('chart-container');
                container.style.background = config.transparent ? 'repeating-conic-gradient(#e0e0e0 0% 25%, #fff 0% 50%) 0 0/20px 20px' : '#FFFFFF';

                if (isFullReset) this.chart.clear();
                this.chart.setOption(option, { notMerge: isFullReset });
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  CLEAR DATA
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            clearData() {
                document.getElementById('data-input').value = '';
                document.getElementById('parse-status').textContent = '';
                this.chart.clear();
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  HD EXPORT â€” 300dpi (pixelRatio â‰ˆ 4)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            getPixelRatio() {
                return Math.max(1, parseInt(document.getElementById('cfg-quality').value || '2', 10));
            },

            base64ToBlob(b64) {
                const bin = atob(b64);
                const arr = new Uint8Array(bin.length);
                for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
                return new Blob([arr], { type: 'image/png' });
            },

            exportHD() {
                if (!this.chart) return;
                const fileName = document.getElementById('cfg-filename').value.trim() || 'ECharts_Table';
                const pr = this.getPixelRatio();
                const label = pr >= 8 ? '8K' : '4K';
                const currentOpt = this.chart.getOption();
                let bg = currentOpt.backgroundColor;
                if (Array.isArray(bg)) bg = bg[0];
                if (!bg || bg === 'transparent') bg = '#FFFFFF';

                try {
                    const dataUrl = this.chart.getDataURL({ type: 'png', pixelRatio: pr, backgroundColor: bg });
                    const blob = this.base64ToBlob(dataUrl.split(',')[1]);
                    saveAs(blob, `${fileName}_${label}.png`);
                } catch (e) {
                    alert('å¯¼å‡ºå¤±è´¥: ' + (e.message || e));
                }
            },

            exportTransparent() {
                if (!this.chart) return;
                const fileName = document.getElementById('cfg-filename').value.trim() || 'ECharts_Table';
                const pr = this.getPixelRatio();
                const label = pr >= 8 ? '8K' : '4K';

                try {
                    const dataUrl = this.chart.getDataURL({ type: 'png', pixelRatio: pr, backgroundColor: 'transparent' });
                    const blob = this.base64ToBlob(dataUrl.split(',')[1]);
                    saveAs(blob, `${fileName}_transparent_${label}.png`);
                } catch (e) {
                    alert('å¯¼å‡ºå¤±è´¥: ' + (e.message || e));
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  OFFSCREEN RENDER for split export
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            _renderOffscreen(data, config, renderMode, bgColor, pixelRatio) {
                return new Promise((resolve, reject) => {
                    const div = document.createElement('div');
                    div.style.cssText = `position:fixed;left:-99999px;top:-99999px;width:${this.state.width}px;height:${this.state.height}px;pointer-events:none;opacity:0;`;
                    document.body.appendChild(div);
                    let offChart = null;
                    try {
                        offChart = echarts.init(div, null, { renderer: 'canvas', devicePixelRatio: 2 });
                        const option = this.buildTableOption(data, config, renderMode);
                        if (!option) throw new Error('æ„å»º option å¤±è´¥');
                        option.animation = false;
                        option.backgroundColor = bgColor;
                        offChart.setOption(option, { notMerge: true });

                        const capture = () => {
                            try {
                                const url = offChart.getDataURL({ type: 'png', pixelRatio, backgroundColor: bgColor });
                                offChart.dispose(); document.body.removeChild(div);
                                resolve(url.split(',')[1]);
                            } catch (err) {
                                offChart.dispose(); document.body.removeChild(div); reject(err);
                            }
                        };
                        let done = false;
                        const once = () => { if (!done) { done = true; capture(); } };
                        requestAnimationFrame(() => requestAnimationFrame(() => setTimeout(once, 150)));
                        setTimeout(once, 2000);
                    } catch (err) {
                        if (offChart) try { offChart.dispose(); } catch (_) { }
                        try { document.body.removeChild(div); } catch (_) { }
                        reject(err);
                    }
                });
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  SPLIT ZIP EXPORT: bg-only + text-only
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async exportSplitZip() {
                if (!this.chart) return;
                if (typeof JSZip === 'undefined') { alert('JSZip æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢'); return; }
                const btn = document.getElementById('export-zip-btn');
                const statusEl = document.getElementById('export-status');
                const fileName = document.getElementById('cfg-filename').value.trim() || 'ECharts_Table';
                const pr = this.getPixelRatio();
                const label = pr >= 8 ? '8K' : '4K';
                const raw = document.getElementById('data-input').value;
                const data = this.parseInputData(raw);
                if (!data) { if (statusEl) statusEl.textContent = 'âš ï¸ æ— æ•°æ®å¯å¯¼å‡º'; return; }
                const config = this.getConfig();

                btn.disabled = true; btn.textContent = 'â³ å¯¼å‡ºä¸­...';
                if (statusEl) { statusEl.textContent = 'æ­£åœ¨æ¸²æŸ“ã€Œä»…èƒŒæ™¯ã€...'; statusEl.style.color = '#86868b'; }

                try {
                    // Step 1: background only
                    const bgB64 = await this._renderOffscreen(data, config, 'bgOnly', '#FFFFFF', pr);
                    if (statusEl) statusEl.textContent = 'æ­£åœ¨æ¸²æŸ“ã€Œä»…æ–‡å­—ã€...';

                    // Step 2: text only
                    const txtB64 = await this._renderOffscreen(data, config, 'textOnly', 'transparent', pr);
                    if (statusEl) statusEl.textContent = 'æ­£åœ¨æ‰“åŒ… ZIP...';

                    // Step 3: pack ZIP
                    const zip = new JSZip();
                    const folder = zip.folder(fileName);
                    folder.file(`ä»…èƒŒæ™¯_${label}.png`, bgB64, { base64: true });
                    folder.file(`ä»…æ–‡å­—_${label}.png`, txtB64, { base64: true });
                    const blob = await zip.generateAsync({ type: 'blob' });
                    saveAs(blob, `${fileName}_èƒŒæ™¯ä¸æ–‡å­—_${label}.zip`);

                    if (statusEl) { statusEl.textContent = 'âœ… ZIP å¯¼å‡ºæˆåŠŸï¼ˆå«2å¼ å›¾ï¼‰'; statusEl.style.color = '#34c759'; }
                } catch (e) {
                    if (statusEl) { statusEl.textContent = 'âŒ å¯¼å‡ºå¤±è´¥: ' + (e.message || e); statusEl.style.color = '#ff3b30'; }
                } finally {
                    btn.disabled = false; btn.textContent = 'ğŸ“¦ å¯¼å‡ºã€Œä»…èƒŒæ™¯ã€+ã€Œä»…æ–‡å­—ã€ZIP';
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  AUTO-FIT CANVAS TO DATA
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            autoFitToData(data) {
                if (!data) return;
                const cols = data.headers.length;
                const rows = data.rows.length;
                const config = this.getConfig();
                const ROW_H = config.rowHeight;
                const TOTAL_ROWS = rows + 1;
                // Calculate ideal width: ~180px per column, min 800
                const idealW = Math.max(800, Math.min(2400, cols * 180));
                // Calculate ideal height: table height + title space + padding
                const tableH = TOTAL_ROWS * ROW_H;
                const idealH = Math.max(600, Math.min(4000, tableH + 160));

                if (this.state.width !== idealW || this.state.height !== idealH) {
                    this.state.width = idealW; this.state.height = idealH;
                    const dom = document.getElementById('chart-container');
                    dom.style.width = idealW + 'px'; dom.style.height = idealH + 'px';
                    if (this.chart) this.chart.resize({ width: idealW, height: idealH });
                    this.autoFit();
                }
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  CANVAS SIZE
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            applyCanvasSize() {
                const val = document.getElementById('cfg-canvas').value;
                if (val === 'auto') { this.render(true); return; }
                const parts = val.split(',');
                const w = parseInt(parts[0]); const h = parseInt(parts[1]);
                if (!isNaN(w) && !isNaN(h)) { this.state.width = w; this.state.height = h; }
                const dom = document.getElementById('chart-container');
                dom.style.width = this.state.width + 'px';
                dom.style.height = this.state.height + 'px';
                if (this.chart) this.chart.resize({ width: this.state.width, height: this.state.height });
                this.autoFit();
                this.render(true);
            },

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //  ZOOM & PAN CONTROLS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            zoom(delta) {
                this.state.viewScale = Math.min(5, Math.max(0.05, this.state.viewScale + delta));
                this.updateTransform();
            },
            resetZoom() { this.state.viewScale = 1; this.state.viewX = 0; this.state.viewY = 0; this.updateTransform(); },
            autoFit() {
                const wrap = document.getElementById('preview-stage');
                this.state.viewScale = Math.min(
                    (wrap.clientWidth - 80) / this.state.width,
                    (wrap.clientHeight - 80) / this.state.height
                );
                this.state.viewX = 0; this.state.viewY = 0;
                this.updateTransform();
            },
            updateTransform() {
                const dom = document.getElementById('chart-container');
                dom.style.transform = `translate(${this.state.viewX}px, ${this.state.viewY}px) scale(${this.state.viewScale})`;
                document.getElementById('zoom-level').textContent = Math.round(this.state.viewScale * 100) + '%';
            },

            initCanvasControl() {
                const stage = document.getElementById('preview-stage');
                const chartDom = document.getElementById('chart-container');
                let isDragging = false, startX, startY, isSpacePressed = false;

                stage.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    this.zoom(e.deltaY > 0 ? -0.05 : 0.05);
                }, { passive: false });

                window.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && !e.repeat && !['TEXTAREA', 'INPUT'].includes(document.activeElement.tagName)) {
                        isSpacePressed = true; stage.style.cursor = 'grab'; chartDom.style.pointerEvents = 'none';
                    }
                });
                window.addEventListener('keyup', (e) => {
                    if (e.code === 'Space') { isSpacePressed = false; stage.style.cursor = ''; chartDom.style.pointerEvents = 'auto'; }
                });

                stage.addEventListener('mousedown', (e) => {
                    if (e.button === 1 || (e.button === 0 && isSpacePressed) || (e.button === 0 && e.target === stage)) {
                        isDragging = true;
                        startX = e.clientX - this.state.viewX;
                        startY = e.clientY - this.state.viewY;
                        stage.style.cursor = 'grabbing';
                        e.preventDefault();
                    }
                });
                window.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    this.state.viewX = e.clientX - startX;
                    this.state.viewY = e.clientY - startY;
                    this.updateTransform();
                });
                window.addEventListener('mouseup', () => {
                    if (isDragging) { isDragging = false; stage.style.cursor = isSpacePressed ? 'grab' : ''; }
                });
            },
        };

        window.onload = () => App.init();
    </script>

</body>

</html>